{% extends "index.html" %}

{% block main_content %}
<div class="notice-box">
    本页面是{{ current_university }}的招生要项原文和AI翻译的参考翻译。你也可以直接查看<a
        href="{{ url_for('university_report', name=current_university) }}">基础分析报告</a>。
    <br />
    受限于当前技术条件并不能100%准确的传达原版招生信息的内容，且原版内容可能会发生更新或调整。为了保证不耽误你的升学，还请务必访问大学官网确认更加准确的信息。
</div>

<!-- Tab Navigation -->
<div class="row mb-3">
    <div class="col-12">
        <ul class="nav nav-tabs" id="contentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="japanese-tab" data-bs-toggle="tab"
                    data-bs-target="#japanese-content" type="button" role="tab" aria-controls="japanese-content"
                    aria-selected="true">
                    日文
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="chinese-tab" data-bs-toggle="tab" data-bs-target="#chinese-content"
                    type="button" role="tab" aria-controls="chinese-content" aria-selected="false">
                    中文参考
                </button>
            </li>
            <li class="nav-item d-none d-lg-block" role="presentation">
                <button class="nav-link" id="both-tab" data-bs-toggle="tab" data-bs-target="#both-content" type="button"
                    role="tab" aria-controls="both-content" aria-selected="false">
                    同时显示
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Tab Content -->
<div class="tab-content" id="contentTabsContent">
    <!-- Japanese PDF Tab -->
    <div class="tab-pane fade show active" id="japanese-content" role="tabpanel" aria-labelledby="japanese-tab">
        <div id="pdf-loading" class="text-center py-5 d-flex flex-column justify-content-center">
            <div class="progress" style="height: 20px; background-color: #e9ecef; border-radius: 0.375rem; overflow: hidden;">
                <div id="pdf-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background-color: #007bff; color: white; text-align: center; line-height: 20px; font-size: 12px;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div class="mt-2" id="pdf-loading-text" style="color: #6c757d; font-size: 14px;">正在加载PDF文件...</div>
        </div>
        <div id="pdf-container" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-3 sticky-top bg-light py-2 border-bottom">
                <div>
                    <span class="mx-2 fw-bold">共 <span id="page-count">0</span> 页</span>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" id="zoom-out">缩小</button>
                    <button class="btn btn-outline-secondary btn-sm" id="zoom-in">放大</button>
                    <span class="mx-2"><span id="zoom-level">100</span>%</span>
                </div>
            </div>
            <div id="pdf-pages-container" class="text-center">
                <!-- PDF pages will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Chinese Content Tab -->
    <div class="tab-pane fade" id="chinese-content" role="tabpanel" aria-labelledby="chinese-tab">
        <div id="chinese-markdown-content">
            {{ chinese_content | safe }}
        </div>
    </div>

    <!-- Both Content Tab (Desktop Only) -->
    <div class="tab-pane fade" id="both-content" role="tabpanel" aria-labelledby="both-tab">
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">日文原文 (PDF)</h5>
                    <div id="pdf-controls-both">
                        <button class="btn btn-outline-secondary btn-sm me-1" id="zoom-out-both">-</button>
                        <button class="btn btn-outline-secondary btn-sm" id="zoom-in-both">+</button>
                    </div>
                </div>
                <div class="border border-2 rounded-3" style="border-color: #dee2e6 !important; height: 800px; overflow: hidden; background-color: #fafafa; position: relative;">
                    <div id="pdf-loading-both" class="text-center py-5 h-100 d-flex flex-column justify-content-center">
                        <div class="progress mx-4" style="height: 15px; background-color: #e9ecef; border-radius: 0.375rem; overflow: hidden;">
                            <div id="pdf-progress-bar-both" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; font-size: 10px; background-color: #007bff; color: white; text-align: center; line-height: 15px;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="mt-2 small" id="pdf-loading-text-both" style="color: #6c757d;">正在加载PDF文件...</div>
                    </div>
                    <div id="pdf-container-both" class="h-100 overflow-auto d-none">
                        <div id="pdf-pages-container-both" class="text-center p-3">
                            <!-- PDF pages for the 'both' view will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">中文参考</h5>
                    <div style="height: 32px;"></div>
                </div>
                <div class="border border-2 rounded-3" style="border-color: #dee2e6 !important; height: 800px; overflow-y: auto; padding: 15px; background-color: #fafafa;">
                    <div id="chinese-content-both">
                        {{ chinese_content | safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 聊天入口 -->
{% include 'chat_modal.html' %}

{% if debug_file_path %}
<div style="position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffc107; padding: 10px; border-top: 2px solid #e0a800; font-family: monospace; font-size: 12px; z-index: 9999;">
    <strong>[DEBUG]</strong> 此页面内容由文件系统加载: {{ debug_file_path }}
</div>
{% endif %}

<script type="module">
    console.log('Starting PDF.js ES module loading...');

    let pdfjsLib = null;
    let pdfDoc = null;
    let scale;
    let scaleBoth;
    let isPdfLoaded = false;
    let isPdfLoading = false;

    try {
        pdfjsLib = await import('https://cdn.jsdelivr.net/npm/pdfjs-dist@5.3.31/build/pdf.min.mjs');
        if (pdfjsLib.GlobalWorkerOptions) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@5.3.31/build/pdf.worker.min.mjs';
        }
    } catch (error) {
        console.error('Failed to load PDF.js:', error);
        document.getElementById('pdf-loading').innerHTML = `<div class="alert alert-danger">PDF.js模块加载失败: ${error.message}</div>`;
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeUI);
    } else {
        initializeUI();
    }

    function initializeUI() {
        const japaneseTab = document.getElementById('japanese-tab');
        const bothTab = document.getElementById('both-tab');

        japaneseTab.addEventListener('shown.bs.tab', () => handleTabSwitch(true));
        bothTab.addEventListener('shown.bs.tab', () => handleTabSwitch(false));

        setupEventHandlers();
        handleTabSwitch(true);
    }

    function handleTabSwitch(isMainViewer) {
        if (isPdfLoaded) {
            renderVisiblePdf(isMainViewer);
        } else {
            loadPdf();
        }
    }

    async function renderAllPages(pdfDoc, container, scale) {
        container.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (let num = 1; num <= pdfDoc.numPages; num++) {
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page-canvas border mb-3 d-block mx-auto';
            fragment.appendChild(canvas);
        }
        container.appendChild(fragment);

        for (let i = 0; i < container.children.length; i++) {
            const canvas = container.children[i];
            const pageNum = i + 1;
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: scale });
                const devicePixelRatio = window.devicePixelRatio || 1;
                const outputScale = devicePixelRatio;

                canvas.width = Math.floor(viewport.width * outputScale);
                canvas.height = Math.floor(viewport.height * outputScale);
                canvas.style.width = Math.floor(viewport.width) + 'px';
                canvas.style.height = Math.floor(viewport.height) + 'px';

                const context = canvas.getContext('2d');
                context.scale(outputScale, outputScale);

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport,
                    enableWebGL: true,
                    renderInteractiveForms: false
                };
                await page.render(renderContext).promise;
            } catch (error) {
                console.error(`Error rendering page ${pageNum}:`, error);
            }
        }
    }

    function renderVisiblePdf(isMainViewer) {
        const containerId = isMainViewer ? 'pdf-pages-container' : 'pdf-pages-container-both';
        const currentScale = isMainViewer ? scale : scaleBoth;
        const container = document.getElementById(containerId);
        if (pdfDoc && container && container.children.length === 0) {
            renderAllPages(pdfDoc, container, currentScale);
        }
    }

    function calculateInitialScale(page, container) {
        const containerWidth = container.clientWidth - 20; // 20px padding
        const viewport = page.getViewport({ scale: 1.0 });
        const calculatedScale = containerWidth / viewport.width;
        return Math.max(0.5, Math.min(1.8, calculatedScale)); // Clamp between 50% and 180%
    }

    function loadPdf() {
        if (isPdfLoading || isPdfLoaded) return;
        if (!pdfjsLib) {
            setTimeout(loadPdf, 100);
            return;
        }

        isPdfLoading = true;

        const pdfUrl = '{{ pdf_url }}';

        async function loadPDFWithProgress() {
            const response = await fetch(pdfUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const total = parseInt(response.headers.get('content-length') || '0', 10);
            let loaded = 0;
            const reader = response.body.getReader();
            const chunks = [];
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                updateProgressDisplay(loaded, total);
            }
            const combinedArray = new Uint8Array(loaded);
            let offset = 0;
            for (const chunk of chunks) {
                combinedArray.set(chunk, offset);
                offset += chunk.length;
            }
            updateProgressDisplay(loaded, loaded);
            const blob = new Blob([combinedArray], { type: 'application/pdf' });
            return pdfjsLib.getDocument({ url: URL.createObjectURL(blob) }).promise;
        }

        function updateProgressDisplay(loaded, total) {
            const percent = total > 0 ? Math.round((loaded / total) * 100) : 0;
            const message = total > 0 ?
                `正在加载PDF文件... (${(loaded / 1024 / 1024).toFixed(2)} MB / ${(total / 1024 / 1024).toFixed(2)} MB)` :
                `正在加载PDF文件... (已下载 ${(loaded / 1024 / 1024).toFixed(2)} MB)`;

            ['pdf-progress-bar', 'pdf-progress-bar-both'].forEach(barId => {
                const progressBar = document.getElementById(barId);
                if (progressBar) {
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                }
            });
            ['pdf-loading-text', 'pdf-loading-text-both'].forEach(textId => {
                const loadingText = document.getElementById(textId);
                if (loadingText) loadingText.textContent = message;
            });
        }

        loadPDFWithProgress().then(async (pdfDoc_) => {
            pdfDoc = pdfDoc_;
            isPdfLoaded = true;
            isPdfLoading = false;
            document.getElementById('page-count').textContent = pdfDoc.numPages;

            // Calculate initial scales
            const firstPage = await pdfDoc.getPage(1);
            scale = calculateInitialScale(firstPage, document.getElementById('pdf-pages-container'));
            scaleBoth = calculateInitialScale(firstPage, document.getElementById('pdf-pages-container-both'));
            document.getElementById('zoom-level').textContent = Math.round(scale * 100);

            // Hide loading and show containers
            document.getElementById('pdf-loading').classList.add('d-none');
            document.getElementById('pdf-loading-both').classList.add('d-none');
            document.getElementById('pdf-container').classList.remove('d-none');
            document.getElementById('pdf-container-both').classList.remove('d-none');

            // Render the currently active tab
            if (document.getElementById('japanese-content').classList.contains('show')) {
                renderVisiblePdf(true);
            }
            if (document.getElementById('both-content').classList.contains('show')) {
                renderVisiblePdf(false);
            }

        }).catch(error => {
            isPdfLoading = false;
            console.error('Error loading PDF:', error);
            const errorHtml = `<div class="alert alert-danger">PDF加载失败: ${error.message}，请稍后重试</div>`;
            ['pdf-loading', 'pdf-loading-both'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = errorHtml;
                    el.classList.remove('d-flex');
                }
            });
        });
    }

    function setupEventHandlers() {
        document.getElementById('zoom-in').addEventListener('click', () => {
            scale *= 1.2;
            document.getElementById('zoom-level').textContent = Math.round(scale * 100);
            if (pdfDoc) renderAllPages(pdfDoc, document.getElementById('pdf-pages-container'), scale);
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            scale /= 1.2;
            document.getElementById('zoom-level').textContent = Math.round(scale * 100);
            if (pdfDoc) renderAllPages(pdfDoc, document.getElementById('pdf-pages-container'), scale);
        });

        document.getElementById('zoom-in-both').addEventListener('click', () => {
            scaleBoth *= 1.2;
            if (pdfDoc) renderAllPages(pdfDoc, document.getElementById('pdf-pages-container-both'), scaleBoth);
        });

        document.getElementById('zoom-out-both').addEventListener('click', () => {
            scaleBoth /= 1.2;
            if (pdfDoc) renderAllPages(pdfDoc, document.getElementById('pdf-pages-container-both'), scaleBoth);
        });

        window.addEventListener('resize', () => {
            const bothTab = document.getElementById('both-tab');
            if (window.innerWidth < 992) {
                if (bothTab) bothTab.style.display = 'none';
            } else {
                if (bothTab) bothTab.style.display = 'block';
            }
        });
        if (window.innerWidth < 992) {
            const bothTab = document.getElementById('both-tab');
            if (bothTab) bothTab.style.display = 'none';
        }
    }
</script>
{% endblock %}
