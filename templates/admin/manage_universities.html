{% extends "admin/layout.html" %}

{% block title %}招生信息一览{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>招生信息一览</h2>
    <p>这里是从MongoDB数据库中读取的大学招生信息列表。</p>
    
    <div class="mb-3 d-flex align-items-center gap-3">
        <div class="flex-grow-1">
            <div id="tag-filter" class="d-flex flex-wrap gap-2"></div>
        </div>
        <button id="clear-universities-btn" class="btn btn-danger">清空所有招生信息数据</button>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>大学名称</th>
                <th>中文名</th>
                <th>Premium</th>
                <th>报名截止日期</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="universities-tbody">
            <!-- Data will be loaded here by JavaScript -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('universities-tbody');
    const clearBtn = document.getElementById('clear-universities-btn');
    const tagContainer = document.getElementById('tag-filter');
    let selectedTags = [];

    async function loadUniversities() {
        try {
            const params = new URLSearchParams();
            if (selectedTags.length > 0) {
                params.set('tags', selectedTags.join(','));
            }
            const url = '/admin/api/universities' + (params.toString() ? ('?' + params.toString()) : '');
            const response = await fetch(url);
            
            if (!response.ok) {
                const errorText = await response.text();
                alert(`加载招生信息数据失败: ${response.status} ${response.statusText}\n${errorText}`);
                return;
            }

            const data = await response.json();
            tbody.innerHTML = ''; // Clear existing data

            if (!Array.isArray(data)) {
                alert('加载数据时遇到错误: 返回的数据格式不正确。');
                return;
            }

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">数据库中没有招生信息。</td></tr>';
                return;
            }

            data.forEach(uni => {
                const createdAt = uni.created_at ? new Date(uni.created_at).toLocaleString() : 'N/A';
                const isPremium = uni.is_premium ? '<span class="badge bg-success">是</span>' : '<span class="badge bg-secondary">否</span>';
                const deadline = uni.deadline ? new Date(uni.deadline).toLocaleDateString() : 'N/A';
                const row = `
                    <tr>
                        <td>${uni.university_name || 'N/A'}</td>
                        <td>${uni.university_name_zh || 'N/A'}</td>
                        <td>${isPremium}</td>
                        <td>${deadline}</td>
                        <td>${createdAt}</td>
                        <td>
                            <a href="/admin/edit_university/${uni._id}" class="btn btn-sm btn-primary">编辑</a>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${uni._id}">删除</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (error) {
            console.error("加载招生信息列表时发生严重JS错误:", error);
            alert(`加载招生信息列表时发生严重JS错误: ${error.message}`);
        }
    }

    async function loadTags() {
        try {
            const resp = await fetch('/admin/api/university-tags');
            if (!resp.ok) {
                return;
            }
            const tags = await resp.json();
            tagContainer.innerHTML = '';
            if (Array.isArray(tags) && tags.length > 0) {
                tags.forEach(item => {
                    const tag = item.tag;
                    const count = item.count;
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-sm btn-outline-primary';
                    btn.dataset.tag = tag;
                    btn.textContent = `${tag} (${count})`;
                    btn.addEventListener('click', () => {
                        const t = btn.dataset.tag;
                        const idx = selectedTags.indexOf(t);
                        if (idx >= 0) {
                            selectedTags.splice(idx, 1);
                            btn.classList.remove('active');
                        } else {
                            if (selectedTags.length >= 2) {
                                // 最多仅允许选择2个标签
                                return;
                            }
                            selectedTags.push(t);
                            btn.classList.add('active');
                        }
                        loadUniversities();
                    });
                    tagContainer.appendChild(btn);
                });
            }
        } catch (e) {
            console.error('加载标签失败', e);
        }
    }

    tbody.addEventListener('click', async function(e) {
        if (e.target.classList.contains('delete-btn')) {
            const itemId = e.target.dataset.id;
            if (confirm('确定要删除这条记录吗？')) {
                try {
                    const response = await fetch(`/admin/api/universities/${itemId}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        alert(`删除失败: ${data.message || response.statusText}`);
                    } else {
                        alert(data.message);
                    }
                    loadUniversities();
                } catch (error) {
                    alert(`删除操作时发生网络错误: ${error.message}`);
                }
            }
        }
    });

    clearBtn.addEventListener('click', async function() {
        if (confirm('警告：这将删除所有招生信息数据，操作不可逆！确定要继续吗？')) {
            try {
                const response = await fetch('/admin/api/universities', {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (!response.ok) {
                    alert(`清空失败: ${data.message || response.statusText}`);
                } else {
                    alert(data.message);
                }
                loadUniversities();
            } catch (error) {
                alert(`清空操作时发生网络错误: ${error.message}`);
            }
        }
    });

    Promise.all([loadTags()]).then(() => loadUniversities());
});
</script>
{% endblock %}