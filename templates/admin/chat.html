{% extends "admin/layout.html" %}

{% block title %}大学AI对话测试系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">大学AI对话测试系统</h1>
    
    <!-- 状态指示器 -->
    <div id="statusIndicator" class="alert alert-info mb-4" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span id="statusText">正在处理...</span>
        </div>
    </div>
    
    <!-- 错误信息 -->
    <div id="errorAlert" class="alert alert-danger alert-dismissible" style="display: none;">
        <span id="errorText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <!-- 大学选择阶段 -->
    <div id="universitySelection" class="card">
        <div class="card-header">
            <h3 class="card-title mb-0">1. 选择大学</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <label for="universitySearch" class="form-label">搜索大学名称</label>
                    <input type="text" class="form-control" id="universitySearch" placeholder="输入大学名称进行搜索...">
                    
                    <!-- 搜索结果 -->
                    <div id="searchResults" class="mt-3" style="display: none;">
                        <h6>搜索结果：</h6>
                        <div id="searchResultsList" class="list-group"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>已选大学：</h6>
                    <div id="selectedUniversity" class="mt-2">
                        <span class="text-muted">未选择</span>
                    </div>
                    <button type="button" class="btn btn-primary mt-3" id="startChatBtn" style="display: none;">开始对话</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载进度阶段 -->
    <div id="loadingProgress" class="card mt-4" style="display: none;">
        <div class="card-header">
            <h3 class="card-title mb-0">2. 正在加载大学文档</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5 id="loadingUniversityName">大学：</h5>
                    <div class="progress mb-3" role="progressbar">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                    </div>
                    <p id="loadingStep" class="text-muted">准备中...</p>
                    <p id="estimatedTime" class="text-muted"></p>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-secondary" id="cancelLoadingBtn">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 对话界面 -->
    <div id="chatInterface" class="card mt-4" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0" id="chatTitle">与大学的AI助手对话</h3>
            <div>
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="clearChatBtn">清空对话</button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="newUniversityBtn">重新选择大学</button>
            </div>
        </div>
        <div class="card-body">
            <!-- 对话历史区域 -->
            <div id="chatHistory" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                <div class="text-center text-muted">
                    <p>欢迎使用大学AI对话系统！</p>
                    <p>您可以询问关于这所大学的任何问题。</p>
                </div>
            </div>
            
            <!-- 输入区域 -->
            <div class="input-group">
                <input type="text" class="form-control" id="messageInput" placeholder="请输入您的问题..." maxlength="500">
                <button class="btn btn-primary" type="button" id="sendMessageBtn">
                    <span id="sendButtonText">发送</span>
                    <span id="sendButtonSpinner" class="spinner-border spinner-border-sm ms-1" style="display: none;"></span>
                </button>
            </div>
            <small class="text-muted">按 Enter 键发送消息</small>
        </div>
    </div>
    
    <!-- 统计信息 -->
    <div id="chatStats" class="card mt-4" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">会话信息</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>会话ID：</strong>
                    <br><small id="sessionId" class="text-muted"></small>
                </div>
                <div class="col-md-3">
                    <strong>消息数量：</strong>
                    <br><span id="messageCount">0</span>
                </div>
                <div class="col-md-3">
                    <strong>创建时间：</strong>
                    <br><small id="sessionCreatedAt" class="text-muted"></small>
                </div>
                <div class="col-md-3">
                    <strong>最后活动：</strong>
                    <br><small id="lastActivity" class="text-muted"></small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 全局变量
let selectedUniversityId = null;
let currentSessionId = null;
let searchTimeout = null;
let loadingEventSource = null;

// DOM 元素
const universitySearchInput = document.getElementById('universitySearch');
const searchResults = document.getElementById('searchResults');
const searchResultsList = document.getElementById('searchResultsList');
const selectedUniversityDiv = document.getElementById('selectedUniversity');
const startChatBtn = document.getElementById('startChatBtn');
const universitySelectionCard = document.getElementById('universitySelection');
const loadingProgressCard = document.getElementById('loadingProgress');
const chatInterfaceCard = document.getElementById('chatInterface');
const chatStatsCard = document.getElementById('chatStats');
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const errorAlert = document.getElementById('errorAlert');
const errorText = document.getElementById('errorText');

// 对话相关元素
const chatTitle = document.getElementById('chatTitle');
const chatHistory = document.getElementById('chatHistory');
const messageInput = document.getElementById('messageInput');
const sendMessageBtn = document.getElementById('sendMessageBtn');
const sendButtonText = document.getElementById('sendButtonText');
const sendButtonSpinner = document.getElementById('sendButtonSpinner');
const clearChatBtn = document.getElementById('clearChatBtn');
const newUniversityBtn = document.getElementById('newUniversityBtn');

// 加载进度相关元素
const loadingUniversityName = document.getElementById('loadingUniversityName');
const progressBar = document.getElementById('progressBar');
const loadingStep = document.getElementById('loadingStep');
const estimatedTime = document.getElementById('estimatedTime');
const cancelLoadingBtn = document.getElementById('cancelLoadingBtn');

// 统计信息相关元素
const sessionIdSpan = document.getElementById('sessionId');
const messageCountSpan = document.getElementById('messageCount');
const sessionCreatedAtSpan = document.getElementById('sessionCreatedAt');
const lastActivitySpan = document.getElementById('lastActivity');

// 工具函数
function showStatus(message) {
    statusText.textContent = message;
    statusIndicator.style.display = 'block';
}

function hideStatus() {
    statusIndicator.style.display = 'none';
}

function showError(message) {
    errorText.textContent = message;
    errorAlert.style.display = 'block';
}

function hideError() {
    errorAlert.style.display = 'none';
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
}

// 搜索大学
function searchUniversities(query) {
    if (!query.trim()) {
        searchResults.style.display = 'none';
        return;
    }
    
    showStatus('搜索大学中...');
    
    fetch(`/admin/chat/api/universities/search?q=${encodeURIComponent(query)}&limit=10`)
        .then(response => response.json())
        .then(data => {
            hideStatus();
            if (data.success) {
                displaySearchResults(data.universities);
            } else {
                showError(data.error || '搜索失败');
            }
        })
        .catch(error => {
            hideStatus();
            showError('网络错误：' + error.message);
        });
}

// 显示搜索结果
function displaySearchResults(universities) {
    searchResultsList.innerHTML = '';
    
    if (universities.length === 0) {
        searchResultsList.innerHTML = '<div class="list-group-item text-muted">未找到匹配的大学</div>';
    } else {
        universities.forEach(uni => {
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action';
            item.href = '#';
            item.onclick = (e) => {
                e.preventDefault();
                selectUniversity(uni);
            };
            
            const isPremium = uni.is_premium ? '<span class="badge bg-warning ms-2">精选</span>' : '';
            const deadline = uni.deadline ? `<small class="text-muted">截止日期: ${uni.deadline}</small>` : '';
            
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${uni.name}${isPremium}</h6>
                </div>
                <p class="mb-1">${uni.name_zh || ''}</p>
                ${deadline}
            `;
            
            searchResultsList.appendChild(item);
        });
    }
    
    searchResults.style.display = 'block';
}

// 选择大学
function selectUniversity(university) {
    selectedUniversityId = university.id;
    
    selectedUniversityDiv.innerHTML = `
        <div class="alert alert-success mb-0">
            <strong>${university.name}</strong>
            ${university.name_zh ? `<br><small>${university.name_zh}</small>` : ''}
            ${university.deadline ? `<br><small class="text-muted">截止日期: ${university.deadline}</small>` : ''}
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearSelection()">×</button>
        </div>
    `;
    
    startChatBtn.style.display = 'block';
    searchResults.style.display = 'none';
    universitySearchInput.value = '';
}

// 清除选择
function clearSelection() {
    selectedUniversityId = null;
    selectedUniversityDiv.innerHTML = '<span class="text-muted">未选择</span>';
    startChatBtn.style.display = 'none';
}

// 开始对话
function startChat() {
    if (!selectedUniversityId) {
        showError('请先选择一所大学');
        return;
    }
    
    hideError();
    
    // 切换到加载进度界面
    universitySelectionCard.style.display = 'none';
    loadingProgressCard.style.display = 'block';
    
    // 创建会话
    createChatSession();
}

// 创建聊天会话
function createChatSession() {
    showStatus('创建对话会话...');
    
    fetch('/admin/chat/api/create-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            university_id: selectedUniversityId
        })
    })
    .then(response => response.json())
    .then(data => {
        hideStatus();
        if (data.success) {
            currentSessionId = data.session.session_id;
            
            // 更新界面
            chatTitle.textContent = `与${data.session.university_name}的AI助手对话`;
            loadingUniversityName.textContent = `大学：${data.session.university_name}`;
            
            // 更新统计信息
            updateSessionStats(data.session);
            
            // 模拟加载完成（实际应该监听SSE进度）
            simulateLoading();
        } else {
            showError(data.error || '创建会话失败');
            backToSelection();
        }
    })
    .catch(error => {
        hideStatus();
        showError('网络错误：' + error.message);
        backToSelection();
    });
}

// 模拟加载进度
function simulateLoading() {
    let progress = 0;
    const steps = [
        '检查索引状态...',
        '加载大学文档...',
        '生成向量嵌入...',
        '构建索引...',
        '完成准备工作...'
    ];
    
    const interval = setInterval(() => {
        progress += 20;
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress + '%';
        
        if (progress <= 100) {
            const stepIndex = Math.floor((progress - 1) / 20);
            if (stepIndex < steps.length) {
                loadingStep.textContent = steps[stepIndex];
            }
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                showChatInterface();
            }, 500);
        }
    }, 800);
}

// 显示对话界面
function showChatInterface() {
    loadingProgressCard.style.display = 'none';
    chatInterfaceCard.style.display = 'block';
    chatStatsCard.style.display = 'block';
    
    // 清空对话历史
    chatHistory.innerHTML = `
        <div class="text-center text-muted">
            <p>欢迎使用大学AI对话系统！</p>
            <p>您可以询问关于这所大学的任何问题。</p>
        </div>
    `;
    
    // 聚焦到输入框
    messageInput.focus();
}

// 发送消息
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || !currentSessionId) {
        return;
    }
    
    // 禁用输入
    messageInput.disabled = true;
    sendMessageBtn.disabled = true;
    sendButtonText.style.display = 'none';
    sendButtonSpinner.style.display = 'inline-block';
    
    // 添加用户消息到界面
    addMessageToChat('user', message);
    
    // 清空输入框
    messageInput.value = '';
    
    // 发送到服务器
    fetch('/admin/chat/api/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            session_id: currentSessionId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addMessageToChat('assistant', data.response);
            // 更新统计信息
            if (data.session_info) {
                updateSessionStats(data.session_info);
            }
        } else {
            addMessageToChat('system', `错误: ${data.error}`);
        }
    })
    .catch(error => {
        addMessageToChat('system', `网络错误: ${error.message}`);
    })
    .finally(() => {
        // 重新启用输入
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;
        sendButtonText.style.display = 'inline';
        sendButtonSpinner.style.display = 'none';
        messageInput.focus();
    });
}

// 添加消息到聊天界面
function addMessageToChat(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${role === 'user' ? 'text-end' : ''}`;
    
    const roleLabel = role === 'user' ? '用户' : (role === 'assistant' ? '助手' : '系统');
    const badgeClass = role === 'user' ? 'bg-primary' : (role === 'assistant' ? 'bg-success' : 'bg-warning');
    
    messageDiv.innerHTML = `
        <div class="d-inline-block">
            <span class="badge ${badgeClass} mb-1">${roleLabel}</span>
            <div class="card ${role === 'user' ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 80%;">
                <div class="card-body py-2 px-3">
                    <p class="mb-0">${content.replace(/\n/g, '<br>')}</p>
                    <small class="text-muted">${new Date().toLocaleTimeString('zh-CN')}</small>
                </div>
            </div>
        </div>
    `;
    
    chatHistory.appendChild(messageDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

// 更新会话统计信息
function updateSessionStats(sessionInfo) {
    sessionIdSpan.textContent = sessionInfo.session_id;
    messageCountSpan.textContent = sessionInfo.message_count || 0;
    sessionCreatedAtSpan.textContent = formatDateTime(sessionInfo.created_at);
    lastActivitySpan.textContent = formatDateTime(sessionInfo.last_activity);
}

// 清空对话
function clearChat() {
    if (!currentSessionId) return;
    
    if (!confirm('确定要清空对话历史吗？')) return;
    
    fetch(`/admin/chat/api/session/${currentSessionId}/clear`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            chatHistory.innerHTML = `
                <div class="text-center text-muted">
                    <p>对话历史已清空</p>
                </div>
            `;
            messageCountSpan.textContent = '0';
        } else {
            showError(data.error || '清空失败');
        }
    })
    .catch(error => {
        showError('网络错误：' + error.message);
    });
}

// 返回大学选择界面
function backToSelection() {
    // 清理会话
    if (currentSessionId) {
        fetch(`/admin/chat/api/session/${currentSessionId}`, {
            method: 'DELETE'
        }).catch(() => {}); // 忽略错误
    }
    
    currentSessionId = null;
    selectedUniversityId = null;
    
    // 重置界面
    universitySelectionCard.style.display = 'block';
    loadingProgressCard.style.display = 'none';
    chatInterfaceCard.style.display = 'none';
    chatStatsCard.style.display = 'none';
    
    clearSelection();
    hideError();
    hideStatus();
}

// 事件监听器
universitySearchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        searchUniversities(e.target.value);
    }, 300);
});

startChatBtn.addEventListener('click', startChat);

messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

sendMessageBtn.addEventListener('click', sendMessage);
clearChatBtn.addEventListener('click', clearChat);
newUniversityBtn.addEventListener('click', backToSelection);
cancelLoadingBtn.addEventListener('click', backToSelection);

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 自动聚焦到搜索框
    universitySearchInput.focus();
    
    // 加载一些大学供选择
    searchUniversities('');
});
</script>
{% endblock %}
