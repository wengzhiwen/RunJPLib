{% extends "admin/layout.html" %}

{% block title %}用户聊天记录{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>用户聊天记录</h1>
        <div>
            <button type="button" class="btn btn-outline-secondary me-2" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> 刷新
            </button>
            <button type="button" class="btn btn-outline-info" onclick="showStatistics()">
                <i class="fas fa-chart-bar"></i> 统计信息
            </button>
        </div>
    </div>

    <!-- 筛选器 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">筛选条件</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filterDateStart" class="form-label">开始日期</label>
                    <input type="date" class="form-control" id="filterDateStart">
                </div>
                <div class="col-md-3">
                    <label for="filterDateEnd" class="form-label">结束日期</label>
                    <input type="date" class="form-control" id="filterDateEnd">
                </div>
                <div class="col-md-3">
                    <label for="filterUniversity" class="form-label">大学</label>
                    <select class="form-select" id="filterUniversity">
                        <option value="">全部大学</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filterIp" class="form-label">用户IP</label>
                    <input type="text" class="form-control" id="filterIp" placeholder="输入IP地址">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn btn-primary" onclick="applyFilters()">应用筛选</button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="clearFilters()">清除筛选</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 会话列表 -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">聊天会话列表</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>会话ID</th>
                            <th>用户IP</th>
                            <th>大学</th>
                            <th>开始时间</th>
                            <th>最后活动</th>
                            <th>消息数量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTable">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                加载中...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <nav aria-label="页面导航">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- 分页按钮将在这里生成 -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 会话详情模态框 -->
<div class="modal fade" id="sessionDetailModal" tabindex="-1" aria-labelledby="sessionDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionDetailModalLabel">会话详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 会话基本信息 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr><td><strong>会话ID：</strong></td><td id="detailSessionId"></td></tr>
                            <tr><td><strong>用户IP：</strong></td><td id="detailUserIp"></td></tr>
                            <tr><td><strong>大学：</strong></td><td id="detailUniversity"></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>时间信息</h6>
                        <table class="table table-sm">
                            <tr><td><strong>开始时间：</strong></td><td id="detailStartTime"></td></tr>
                            <tr><td><strong>最后活动：</strong></td><td id="detailLastActivity"></td></tr>
                            <tr><td><strong>消息数量：</strong></td><td id="detailMessageCount"></td></tr>
                        </table>
                    </div>
                </div>
                
                <!-- 对话历史 -->
                <div>
                    <h6>对话历史</h6>
                    <div id="conversationHistory" class="border rounded p-3" style="max-height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                        <!-- 对话内容将在这里显示 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="exportSessionData()">导出数据</button>
            </div>
        </div>
    </div>
</div>

<!-- 统计信息模态框 -->
<div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statisticsModalLabel">聊天统计信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="statisticsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 0;
let pageSize = 20;
let currentFilters = {};
let currentSessionDetail = null;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadSessions();
    loadUniversityFilter();
    
    // 设置默认日期范围（最近7天）
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 7);
    
    document.getElementById('filterDateStart').value = startDate.toISOString().split('T')[0];
    document.getElementById('filterDateEnd').value = endDate.toISOString().split('T')[0];
});

// 加载会话列表
async function loadSessions() {
    try {
        const params = new URLSearchParams({
            skip: currentPage * pageSize,
            limit: pageSize,
            ...currentFilters
        });
        
        const response = await fetch(`/admin/api/chat-sessions?${params}`);
        const data = await response.json();
        
        if (data.success) {
            displaySessions(data.sessions);
            updatePagination(data.total);
        } else {
            showError('加载会话列表失败: ' + data.error);
        }
    } catch (error) {
        console.error('加载会话列表错误:', error);
        showError('网络错误，请重试');
    }
}

// 显示会话列表
function displaySessions(sessions) {
    const tbody = document.getElementById('sessionsTable');
    
    if (sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">没有找到匹配的会话</td></tr>';
        return;
    }
    
    tbody.innerHTML = sessions.map(session => `
        <tr>
            <td><code>${session.session_id.substring(0, 8)}...</code></td>
            <td>${session.user_ip}</td>
            <td>${session.university_name}</td>
            <td>${formatDateTime(session.start_time)}</td>
            <td>${formatDateTime(session.last_activity)}</td>
            <td><span class="badge bg-primary">${session.total_messages}</span></td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        onclick="viewSessionDetail('${session.session_id}')">
                    <i class="fas fa-eye"></i> 查看
                </button>
            </td>
        </tr>
    `).join('');
}

// 更新分页
function updatePagination(total) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.getElementById('pagination');
    
    let paginationHtml = '';
    
    // 上一页
    if (currentPage > 0) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a></li>`;
    }
    
    // 页码
    const startPage = Math.max(0, currentPage - 2);
    const endPage = Math.min(totalPages - 1, startPage + 4);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === currentPage ? 'active' : '';
        paginationHtml += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a></li>`;
    }
    
    // 下一页
    if (currentPage < totalPages - 1) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a></li>`;
    }
    
    pagination.innerHTML = paginationHtml;
}

// 切换页面
function changePage(page) {
    currentPage = page;
    loadSessions();
}

// 查看会话详情
async function viewSessionDetail(sessionId) {
    try {
        const response = await fetch(`/admin/api/chat-sessions/${sessionId}`);
        const data = await response.json();
        
        if (data.success) {
            currentSessionDetail = data.session;
            displaySessionDetail(data.session);
            
            const modal = new bootstrap.Modal(document.getElementById('sessionDetailModal'));
            modal.show();
        } else {
            showError('加载会话详情失败: ' + data.error);
        }
    } catch (error) {
        console.error('加载会话详情错误:', error);
        showError('网络错误，请重试');
    }
}

// 显示会话详情
function displaySessionDetail(session) {
    document.getElementById('detailSessionId').textContent = session.session_id;
    document.getElementById('detailUserIp').textContent = session.user_ip;
    document.getElementById('detailUniversity').textContent = session.university_name;
    document.getElementById('detailStartTime').textContent = formatDateTime(session.start_time);
    document.getElementById('detailLastActivity').textContent = formatDateTime(session.last_activity);
    document.getElementById('detailMessageCount').textContent = session.total_messages;
    
    // 显示对话历史
    const conversationHistory = document.getElementById('conversationHistory');
    
    if (session.messages && session.messages.length > 0) {
        conversationHistory.innerHTML = session.messages.map(msg => `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">${formatDateTime(msg.timestamp)}</small>
                    <small class="text-muted">处理时间: ${msg.processing_time || 0}秒</small>
                </div>
                <div class="border rounded p-2 mb-2 bg-light">
                    <strong>用户:</strong> ${escapeHtml(msg.user_input)}
                </div>
                <div class="border rounded p-2 bg-white">
                    <strong>AI:</strong> ${escapeHtml(msg.ai_response).replace(/\n/g, '<br>')}
                </div>
            </div>
        `).join('');
    } else {
        conversationHistory.innerHTML = '<p class="text-muted text-center">此会话暂无消息记录</p>';
    }
}

// 加载大学筛选器
async function loadUniversityFilter() {
    try {
        const response = await fetch('/admin/api/chat-universities');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('filterUniversity');
            select.innerHTML = '<option value="">全部大学</option>' + 
                data.universities.map(uni => `<option value="${uni}">${uni}</option>`).join('');
        }
    } catch (error) {
        console.error('加载大学列表错误:', error);
    }
}

// 应用筛选
function applyFilters() {
    currentFilters = {};
    
    const startDate = document.getElementById('filterDateStart').value;
    if (startDate) currentFilters.start_date = startDate;
    
    const endDate = document.getElementById('filterDateEnd').value;
    if (endDate) currentFilters.end_date = endDate;
    
    const university = document.getElementById('filterUniversity').value;
    if (university) currentFilters.university = university;
    
    const ip = document.getElementById('filterIp').value.trim();
    if (ip) currentFilters.user_ip = ip;
    
    currentPage = 0;
    loadSessions();
}

// 清除筛选
function clearFilters() {
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    document.getElementById('filterUniversity').value = '';
    document.getElementById('filterIp').value = '';
    
    currentFilters = {};
    currentPage = 0;
    loadSessions();
}

// 显示统计信息
async function showStatistics() {
    try {
        const modal = new bootstrap.Modal(document.getElementById('statisticsModal'));
        modal.show();
        
        const response = await fetch('/admin/api/chat-statistics');
        const data = await response.json();
        
        if (data.success) {
            displayStatistics(data.statistics);
        } else {
            document.getElementById('statisticsContent').innerHTML = 
                '<div class="alert alert-danger">加载统计信息失败</div>';
        }
    } catch (error) {
        console.error('加载统计信息错误:', error);
        document.getElementById('statisticsContent').innerHTML = 
            '<div class="alert alert-danger">网络错误，请重试</div>';
    }
}

// 显示统计信息
function displayStatistics(stats) {
    document.getElementById('statisticsContent').innerHTML = `
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">${stats.total_sessions}</h5>
                        <p class="card-text">总会话数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">${stats.total_messages}</h5>
                        <p class="card-text">总消息数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-info">${stats.active_users}</h5>
                        <p class="card-text">活跃用户(本周)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">${stats.today_sessions}</h5>
                        <p class="card-text">今日会话</p>
                    </div>
                </div>
            </div>
        </div>
        
        <h6>热门大学 (本月)</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr><th>大学</th><th>会话数</th></tr>
                </thead>
                <tbody>
                    ${stats.popular_universities.map(uni => 
                        `<tr><td>${uni._id}</td><td><span class="badge bg-primary">${uni.count}</span></td></tr>`
                    ).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// 导出会话数据
function exportSessionData() {
    if (!currentSessionDetail) return;
    
    const data = {
        session_info: {
            session_id: currentSessionDetail.session_id,
            user_ip: currentSessionDetail.user_ip,
            university_name: currentSessionDetail.university_name,
            start_time: currentSessionDetail.start_time,
            last_activity: currentSessionDetail.last_activity,
            total_messages: currentSessionDetail.total_messages
        },
        messages: currentSessionDetail.messages || []
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat_session_${currentSessionDetail.session_id}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 刷新数据
function refreshData() {
    loadSessions();
    loadUniversityFilter();
}

// 工具函数
function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    // 可以使用 toast 或其他方式显示错误
    alert(message);
}
</script>
{% endblock %}
