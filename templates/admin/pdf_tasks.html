{% extends "layout.html" %}

{% block title %}招生信息生成任务列表{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>招生信息生成任务列表</h1>
    <div>
        <a href="{{ url_for('admin.pdf_processor_page') }}" class="btn btn-primary">新建任务</a>
        <button class="btn btn-outline-secondary" onclick="loadTasks()">
            <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
    </div>
</div>

<!-- 队列状态卡片 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center" id="queue-overview">
                    <div class="col text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务列表 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">任务列表</h5>
    </div>
    <div class="card-body">
        <div id="tasks-container">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始加载，以防SSE连接延迟
    fetchInitialData();
    
    // 连接到SSE流
    const eventSource = new EventSource('/admin/api/pdf/task-stream');

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.queue_status) {
            updateQueueStatus(data.queue_status);
        }
        if (data.tasks) {
            updateTasksTable(data.tasks);
        }
    };

    eventSource.onerror = function(err) {
        console.error("EventSource failed:", err);
        const container = document.getElementById('tasks-container');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    与服务器的实时连接已断开。请检查网络或刷新页面。
                </div>
            `;
        }
        eventSource.close();
    };
});

function fetchInitialData() {
    // 同时获取任务和队列状态
    Promise.all([
        fetch('/admin/api/pdf/tasks').then(res => res.json()),
        fetch('/admin/api/pdf/queue_status').then(res => res.json())
    ]).then(([tasks, queueStatus]) => {
        if (!tasks.error) {
            updateTasksTable(tasks);
        }
        if (!queueStatus.error) {
            updateQueueStatus(queueStatus);
        }
    }).catch(error => {
        console.error('Error fetching initial data:', error);
        document.getElementById('tasks-container').innerHTML = `
            <div class="alert alert-danger" role="alert">
                初始化数据加载失败，请刷新页面重试。
            </div>
        `;
    });
}

function updateQueueStatus(data) {
    const queueOverview = document.getElementById('queue-overview');
    if (!queueOverview) return;

    if (data.error) {
        queueOverview.innerHTML = `
            <div class="col">
                <div class="alert alert-danger" role="alert">
                    加载失败: ${data.error}
                </div>
            </div>
        `;
        return;
    }
    
    queueOverview.innerHTML = `
        <div class="col-3">
            <div class="h4 text-primary">${data.running_tasks}</div>
            <div class="text-muted">正在处理</div>
        </div>
        <div class="col-3">
            <div class="h4 text-warning">${data.queued_tasks}</div>
            <div class="text-muted">队列等待</div>
        </div>
        <div class="col-3">
            <div class="h4 text-info">${data.max_concurrent}</div>
            <div class="text-muted">最大并发</div>
        </div>
        <div class="col-3">
            <div class="h4 text-success">${(data.running_tasks || 0) + (data.queued_tasks || 0)}</div>
            <div class="text-muted">总活跃任务</div>
        </div>
    `;
}

function updateTasksTable(tasks) {
    const container = document.getElementById('tasks-container');
    if (!container) return;

    if (tasks.error) {
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
                加载失败: ${tasks.error}
            </div>
        `;
        return;
    }
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <p>暂无处理任务</p>
                <a href="{{ url_for('admin.pdf_processor_page') }}" class="btn btn-primary">创建第一个任务</a>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>大学名称</th>
                <th>文件名</th>
                <th>状态</th>
                <th>当前步骤</th>
                <th>进度</th>
                <th>创建时间</th>
                <th>更新时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    tasks.forEach(task => {
        // 在JS中处理时间格式化，以防后端SSE流中未处理
        const createdAt = task.created_at_str || (task.created_at ? new Date(task.created_at).toLocaleString() : '-');
        const updatedAt = task.updated_at_str || (task.updated_at ? new Date(task.updated_at).toLocaleString() : '-');

        html += `
            <tr>
                <td><strong>${escapeHtml(task.university_name)}</strong></td>
                <td>${escapeHtml(task.original_filename)}</td>
                <td>${getStatusBadge(task.status)}</td>
                <td>${escapeHtml(task.current_step || '-')}</td>
                <td>
                    <div class="progress" style="width: 100px;">
                        <div class="progress-bar ${getProgressBarClass(task.status)}" 
                             role="progressbar" 
                             style="width: ${task.progress || 0}%" 
                             aria-valuenow="${task.progress || 0}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${task.progress || 0}%
                        </div>
                    </div>
                </td>
                <td><small>${createdAt}</small></td>
                <td><small>${updatedAt}</small></td>
                <td>
                    <a href="/admin/pdf/task/${task._id}" class="btn btn-sm btn-outline-primary">详情</a>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-secondary">等待中</span>',
        'processing': '<span class="badge bg-primary">处理中</span>',
        'completed': '<span class="badge bg-success">已完成</span>',
        'failed': '<span class="badge bg-danger">失败</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">未知</span>';
}

function getProgressBarClass(status) {
    const classes = {
        'pending': 'bg-secondary',
        'processing': 'bg-primary',
        'completed': 'bg-success',
        'failed': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function escapeHtml(text) {
    if (text === null || typeof text === 'undefined') {
        return '';
    }
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
