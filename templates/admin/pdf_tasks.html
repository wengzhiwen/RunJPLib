{% extends "layout.html" %}

{% block title %}招生信息生成任务列表{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>招生信息生成任务列表</h1>
    <div>
        <a href="{{ url_for('admin.pdf_processor_page') }}" class="btn btn-primary">新建任务</a>
        <button class="btn btn-outline-secondary" onclick="loadTasks()">
            <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
        <button class="btn btn-warning" onclick="processQueue()" title="手动触发队列处理">
            <i class="bi bi-gear-fill"></i> 处理队列
        </button>
    </div>
</div>

<!-- 队列状态卡片 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center" id="queue-overview">
                    <div class="col text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务列表 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">任务列表</h5>
    </div>
    <div class="card-body">
        <div id="tasks-container">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始加载，以防SSE连接延迟
    fetchInitialData();
    
    // 启动带重连机制的SSE连接
    connectSSE();
});

let eventSource;
let reconnectAttempts = 0;
const MAX_RECONNECT_DELAY = 30000; // 最大重连间隔30秒

function connectSSE() {
    console.log("Connecting to SSE stream...");
    eventSource = new EventSource('/admin/api/pdf/task-stream');

    eventSource.onopen = function() {
        console.log("SSE connection established.");
        reconnectAttempts = 0; // 连接成功，重置尝试次数
    };

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.queue_status) {
            updateQueueStatus(data.queue_status);
        }
        if (data.tasks) {
            updateTasksTable(data.tasks);
        }
    };

    eventSource.onerror = function(err) {
        console.error("EventSource failed:", err);
        eventSource.close();
        
        // 计算下一次重连的时间（指数退避 + 随机抖动）
        reconnectAttempts++;
        let delay = Math.min(MAX_RECONNECT_DELAY, 1000 * Math.pow(2, reconnectAttempts));
        delay += Math.random() * 1000; // 增加随机性防止客户端同步重连
        
        console.log(`Connection lost. Reconnecting in ${Math.round(delay / 1000)} seconds...`);
        
        // 在UI上给出提示
        const container = document.getElementById('tasks-container');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-warning" role="alert">
                    与服务器的实时连接已断开。正在尝试重新连接...
                </div>
            `;
        }
        
        setTimeout(connectSSE, delay);
    };
}

function fetchInitialData() {
    // 同时获取任务和队列状态
    Promise.all([
        fetch('/admin/api/pdf/tasks').then(res => res.json()),
        fetch('/admin/api/pdf/queue_status').then(res => res.json())
    ]).then(([tasks, queueStatus]) => {
        if (!tasks.error) {
            updateTasksTable(tasks);
        }
        if (!queueStatus.error) {
            updateQueueStatus(queueStatus);
        }
    }).catch(error => {
        console.error('Error fetching initial data:', error);
        document.getElementById('tasks-container').innerHTML = `
            <div class="alert alert-danger" role="alert">
                初始化数据加载失败，请刷新页面重试。
            </div>
        `;
    });
}

function updateQueueStatus(data) {
    const queueOverview = document.getElementById('queue-overview');
    if (!queueOverview) return;

    if (data.error) {
        queueOverview.innerHTML = `
            <div class="col">
                <div class="alert alert-danger" role="alert">
                    加载失败: ${data.error}
                </div>
            </div>
        `;
        return;
    }
    
    queueOverview.innerHTML = `
        <div class="col-3">
            <div class="h4 text-primary">${data.running_tasks}</div>
            <div class="text-muted">正在处理</div>
        </div>
        <div class="col-3">
            <div class="h4 text-warning">${data.queued_tasks}</div>
            <div class="text-muted">队列等待</div>
        </div>
        <div class="col-3">
            <div class="h4 text-info">${data.max_concurrent}</div>
            <div class="text-muted">最大并发</div>
        </div>
        <div class="col-3">
            <div class="h4 text-success">${(data.running_tasks || 0) + (data.queued_tasks || 0)}</div>
            <div class="text-muted">总活跃任务</div>
        </div>
    `;
}

function updateTasksTable(tasks) {
    const container = document.getElementById('tasks-container');
    if (!container) return;

    if (tasks.error) {
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
                加载失败: ${tasks.error}
            </div>
        `;
        return;
    }
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <p>暂无处理任务</p>
                <a href="{{ url_for('admin.pdf_processor_page') }}" class="btn btn-primary">创建第一个任务</a>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>大学名称</th>
                <th>文件名</th>
                <th>状态</th>
                <th>当前步骤</th>
                <th>进度</th>
                <th>创建时间</th>
                <th>更新时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    tasks.forEach(task => {
        // 在JS中处理时间格式化，以防后端SSE流中未处理
        const createdAt = task.created_at_str || (task.created_at ? new Date(task.created_at).toLocaleString() : '-');
        const updatedAt = task.updated_at_str || (task.updated_at ? new Date(task.updated_at).toLocaleString() : '-');

        html += `
            <tr>
                <td><strong>${escapeHtml(task.university_name)}</strong></td>
                <td>${escapeHtml(task.original_filename)}</td>
                <td>${getStatusBadge(task.status)}</td>
                <td>${escapeHtml(task.current_step || '-')}</td>
                <td>
                    <div class="progress" style="width: 100px;">
                        <div class="progress-bar ${getProgressBarClass(task.status)}" 
                             role="progressbar" 
                             style="width: ${task.progress || 0}%" 
                             aria-valuenow="${task.progress || 0}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${task.progress || 0}%
                        </div>
                    </div>
                </td>
                <td><small>${createdAt}</small></td>
                <td><small>${updatedAt}</small></td>
                <td>
                    <a href="/admin/pdf/task/${task._id}" class="btn btn-sm btn-outline-primary">详情</a>
                    ${getTaskActionButtons(task)}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-secondary">等待中</span>',
        'processing': '<span class="badge bg-primary">处理中</span>',
        'completed': '<span class="badge bg-success">已完成</span>',
        'failed': '<span class="badge bg-danger">失败</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">未知</span>';
}

function getProgressBarClass(status) {
    const classes = {
        'pending': 'bg-secondary',
        'processing': 'bg-primary',
        'completed': 'bg-success',
        'failed': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getTaskActionButtons(task) {
    let buttons = '';
    
    // 对于等待中的任务，显示启动按钮
    if (task.status === 'pending') {
        buttons += `
            <button class="btn btn-sm btn-success ms-1" onclick="startTask('${task._id}')" 
                    title="启动任务">
                <i class="bi bi-play-fill"></i> 启动
            </button>
        `;
    }
    
    return buttons;
}

function startTask(taskId) {
    if (!confirm('确定要启动这个任务吗？')) {
        return;
    }
    
    fetch(`/admin/api/pdf/task/${taskId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('启动失败: ' + data.error);
        } else {
            alert('任务已添加到处理队列');
            // 刷新任务列表
            fetchInitialData();
        }
    })
    .catch(error => {
        console.error('Error starting task:', error);
        alert('启动任务时发生错误');
    });
}

function processQueue() {
    if (!confirm('确定要手动触发队列处理吗？这将尝试启动所有等待中的任务。')) {
        return;
    }
    
    fetch('/admin/api/pdf/queue/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('处理队列失败: ' + data.error);
        } else {
            alert('队列处理已触发');
            // 刷新任务列表
            fetchInitialData();
        }
    })
    .catch(error => {
        console.error('Error processing queue:', error);
        alert('处理队列时发生错误');
    });
}

function escapeHtml(text) {
    if (text === null || typeof text === 'undefined') {
        return '';
    }
    
    // 使用更安全的HTML转义方法，保留非英数字字符
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
}
</script>
{% endblock %}
