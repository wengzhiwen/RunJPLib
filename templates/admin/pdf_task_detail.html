{% extends "layout.html" %}

{% block title %}任务详情{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>任务详情</h1>
    <div>
        <a href="{{ url_for('admin.pdf_tasks_page') }}" class="btn btn-outline-secondary">返回列表</a>
        <button class="btn btn-outline-primary" onclick="loadTaskDetail()">
            <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
    </div>
</div>

<!-- 任务基本信息 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>基本信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>任务ID:</strong> {{ task._id }}</p>
                        <p><strong>大学名称:</strong> {{ task.university_name }}</p>
                        <p><strong>文件名:</strong> {{ task.original_filename }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>创建时间:</strong> {{ task.created_at_str if task.created_at_str else task.created_at.strftime('%Y-%m-%d %H:%M:%S') if task.created_at else '-' }}</p>
                        <p id="update-time"><strong>更新时间:</strong> {{ task.updated_at_str if task.updated_at_str else task.updated_at.strftime('%Y-%m-%d %H:%M:%S') if task.updated_at else '-' }}</p>
                        {% if task.error_message %}
                        <p><strong>错误信息:</strong> <span class="text-danger">{{ task.error_message }}</span></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>处理状态</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-3">
                    {% if task.status == 'pending' %}
                        <span class="badge bg-secondary fs-6">等待中</span>
                    {% elif task.status == 'processing' %}
                        <span class="badge bg-primary fs-6">处理中</span>
                    {% elif task.status == 'completed' %}
                        <span class="badge bg-success fs-6">已完成</span>
                    {% elif task.status == 'failed' %}
                        <span class="badge bg-danger fs-6">失败</span>
                    {% else %}
                        <span class="badge bg-secondary fs-6">未知</span>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <div class="progress">
                        <div class="progress-bar 
                            {% if task.status == 'completed' %}bg-success
                            {% elif task.status == 'failed' %}bg-danger
                            {% elif task.status == 'processing' %}bg-primary
                            {% else %}bg-secondary{% endif %}" 
                             role="progressbar" 
                             style="width: {{ task.progress or 0 }}%" 
                             aria-valuenow="{{ task.progress or 0 }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ task.progress or 0 }}%
                        </div>
                    </div>
                </div>
                
                {% if task.current_step %}
                <p id="current-step"><strong>当前步骤:</strong> {{ task.current_step }}</p>
                {% endif %}
                
                {% if task.status in ['completed', 'failed'] %}
                <div class="mt-3">
                    <div class="dropdown">
                        <button class="btn btn-warning btn-sm dropdown-toggle" type="button" id="restartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            从步骤重启
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="restartDropdown">
                            <li><a class="dropdown-item" href="#" onclick="restartFromStep('01_pdf2img')">从PDF转图片重启</a></li>
                            <li><a class="dropdown-item" href="#" onclick="restartFromStep('02_ocr')">从OCR识别重启</a></li>
                            <li><a class="dropdown-item" href="#" onclick="restartFromStep('03_translate')">从翻译重启</a></li>
                            <li><a class="dropdown-item" href="#" onclick="restartFromStep('04_analysis')">从分析重启</a></li>
                            <li><a class="dropdown-item" href="#" onclick="restartFromStep('05_output')">从输出重启</a></li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 处理日志 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>处理日志</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadTaskDetail()">刷新</button>
            </div>
            <div class="card-body">
                <div id="logs-container" style="max-height: 500px; overflow-y: auto;">
                    {% if task.logs and task.logs|length > 0 %}
                        {% for log in task.logs %}
                        <div class="log-entry mb-2 p-2 border-start border-3 
                            {% if log.level == 'ERROR' %}border-danger bg-light-danger
                            {% elif log.level == 'WARNING' %}border-warning bg-light-warning
                            {% else %}border-info bg-light{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <span class="fw-bold text-muted small">
                                        {% if log.timestamp_str %}
                                            {{ log.timestamp_str }}
                                        {% elif log.timestamp %}
                                            {{ log.timestamp.strftime('%H:%M:%S') }}
                                        {% else %}
                                            --:--:--
                                        {% endif %}
                                    </span>
                                    <span class="badge badge-sm 
                                        {% if log.level == 'ERROR' %}bg-danger
                                        {% elif log.level == 'WARNING' %}bg-warning
                                        {% else %}bg-info{% endif %}">
                                        {{ log.level }}
                                    </span>
                                </div>
                            </div>
                            <div class="mt-1">{{ log.message }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-muted text-center py-3">
                            暂无日志信息
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 自动刷新开关 -->
<div class="position-fixed bottom-0 end-0 p-3">
    <div class="card" style="width: 200px;">
        <div class="card-body p-2 d-flex align-items-center">
            <div id="sse-status-light" class="me-2" style="width: 10px; height: 10px; background-color: #6c757d; border-radius: 50%;" title="连接状态"></div>
            <span id="sse-status-text" class="small">连接中...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    connectSSE();
});

let eventSource;
let reconnectAttempts = 0;
const MAX_RECONNECT_DELAY = 30000; // 最大重连间隔30秒
let reconnectTimer;

function connectSSE() {
    const taskId = '{{ task._id }}';
    const statusLight = document.getElementById('sse-status-light');
    const statusText = document.getElementById('sse-status-text');

    eventSource = new EventSource(`/admin/api/pdf/task-stream/${taskId}`);
    statusText.textContent = '连接中...';
    statusLight.style.backgroundColor = '#ffc107'; // Yellow for connecting

    eventSource.onopen = function() {
        console.log("SSE connection established.");
        reconnectAttempts = 0;
        if (reconnectTimer) clearTimeout(reconnectTimer);
        statusLight.style.backgroundColor = '#198754'; // Green for connected
        statusText.textContent = '实时更新已连接';
    };

    eventSource.onmessage = function(event) {
        const task = JSON.parse(event.data);
        updateTaskInfo(task);
        updateLogs(task.logs || []);

        if (task.status === 'completed' || task.status === 'failed') {
            eventSource.close();
            console.log("Task finished. SSE connection closed.");
            statusLight.style.backgroundColor = '#6c757d'; // Grey for closed
            statusText.textContent = '任务结束，连接已关闭';
        }
    };

    eventSource.onerror = function(err) {
        console.error("EventSource failed:", err);
        eventSource.close();
        
        // 只有在任务不是终态时才重连
        const statusBadge = document.querySelector('.badge.fs-6');
        const isTaskFinished = statusBadge && (statusBadge.textContent === '已完成' || statusBadge.textContent === '失败');
        
        if (isTaskFinished) {
            statusLight.style.backgroundColor = '#6c757d';
            statusText.textContent = '任务结束，连接已关闭';
            return;
        }

        reconnectAttempts++;
        let delay = Math.min(MAX_RECONNECT_DELAY, 1000 * Math.pow(2, reconnectAttempts));
        delay += Math.random() * 1000;
        
        statusLight.style.backgroundColor = '#dc3545'; // Red for error/disconnected
        statusText.textContent = `连接断开，${Math.round(delay / 1000)}秒后重试...`;
        
        console.log(`Reconnecting in ${Math.round(delay / 1000)} seconds...`);
        reconnectTimer = setTimeout(connectSSE, delay);
    };
}

// Manual refresh function in case SSE fails
function loadTaskDetail() {
    const taskId = '{{ task._id }}';
    
    fetch(`/admin/api/pdf/task/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading task detail:', data.error);
                return;
            }
            updateTaskInfo(data);
            updateLogs(data.logs || []);
        })
        .catch(error => {
            console.error('Error loading task detail:', error);
        });
}

function updateTaskInfo(task) {
    // 更新状态徽章
    const statusBadge = document.querySelector('.badge.fs-6');
    if (statusBadge) {
        const statusMap = {
            'pending': { class: 'bg-secondary', text: '等待中' },
            'processing': { class: 'bg-primary', text: '处理中' },
            'completed': { class: 'bg-success', text: '已完成' },
            'failed': { class: 'bg-danger', text: '失败' }
        };
        
        const status = statusMap[task.status] || { class: 'bg-secondary', text: '未知' };
        statusBadge.className = `badge fs-6 ${status.class}`;
        statusBadge.textContent = status.text;
    }
    
    // 更新进度条
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        const progress = task.progress || 0;
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = `${progress}%`;
        progressBar.className = `progress-bar ${getProgressBarClass(task.status)}`;
    }
    
    // 更新当前步骤
    const currentStepElement = document.getElementById('current-step');
    if (currentStepElement) {
        currentStepElement.innerHTML = `<strong>当前步骤:</strong> ${escapeHtml(task.current_step || '-')}`;
    }
    
    // 更新时间
    const updateTimeElement = document.getElementById('update-time');
    if (updateTimeElement && task.updated_at_str) {
        updateTimeElement.innerHTML = `<strong>更新时间:</strong> ${escapeHtml(task.updated_at_str)}`;
    }

    // 更新错误信息
    const errorElement = document.querySelector('.text-danger');
    if (task.error_message) {
        if (errorElement) {
            errorElement.textContent = task.error_message;
        } else {
            // 如果错误信息元素不存在，则创建它
            const timeElement = document.getElementById('update-time');
            if (timeElement && timeElement.parentElement) {
                const p = document.createElement('p');
                p.innerHTML = `<strong>错误信息:</strong> <span class="text-danger">${escapeHtml(task.error_message)}</span>`;
                timeElement.parentElement.appendChild(p);
            }
        }
    } else if (errorElement) {
        // 如果没有错误信息但元素存在，则移除
        if (errorElement.parentElement && errorElement.parentElement.tagName === 'P') {
            errorElement.parentElement.remove();
        }
    }
}

function updateLogs(logs) {
    const logsContainer = document.getElementById('logs-container');
    if (!logsContainer) return;
    
    if (!logs || logs.length === 0) {
        logsContainer.innerHTML = `<div class="text-muted text-center py-3">暂无日志信息</div>`;
        return;
    }
    
    let html = '';
    logs.forEach(log => {
        const borderClass = log.level === 'ERROR' ? 'border-danger bg-light-danger' :
                           log.level === 'WARNING' ? 'border-warning bg-light-warning' :
                           'border-info bg-light';
        
        const badgeClass = log.level === 'ERROR' ? 'bg-danger' :
                          log.level === 'WARNING' ? 'bg-warning' :
                          'bg-info';
        
        html += `
            <div class="log-entry mb-2 p-2 border-start border-3 ${borderClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <span class="fw-bold text-muted small">${log.timestamp_str || '--:--:--'}</span>
                        <span class="badge badge-sm ${badgeClass}">${log.level}</span>
                    </div>
                </div>
                <div class="mt-1">${escapeHtml(log.message)}</div>
            </div>
        `;
    });
    
    logsContainer.innerHTML = html;
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

function getProgressBarClass(status) {
    const classes = {
        'pending': 'bg-secondary',
        'processing': 'bg-primary',
        'completed': 'bg-success',
        'failed': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function escapeHtml(text) {
    if (text === null || typeof text === 'undefined') {
        return '';
    }
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function restartFromStep(stepName) {
    const taskId = '{{ task._id }}';
    const stepNames = {
        '01_pdf2img': 'PDF转图片',
        '02_ocr': 'OCR识别',
        '03_translate': '翻译',
        '04_analysis': '分析',
        '05_output': '输出'
    };
    
    if (!confirm(`确定要从"${stepNames[stepName]}"步骤重启任务吗？`)) {
        return;
    }
    
    fetch(`/admin/api/pdf/task/${taskId}/restart`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ step_name: stepName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`重启失败: ${data.error}`);
        } else {
            alert(data.message);
            setTimeout(() => { location.reload(); }, 1000);
        }
    })
    .catch(error => {
        console.error('Error restarting task:', error);
        alert('重启任务时发生网络错误');
    });
}
</script>

<style>
.bg-light-danger {
    background-color: #f8d7da !important;
}

.bg-light-warning {
    background-color: #fff3cd !important;
}

.log-entry {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
}
</style>
{% endblock %}
