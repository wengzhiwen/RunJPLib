{% extends "admin/layout.html" %}

{% block title %}编辑博客{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>编辑博客</h2>
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    {% if blog %}
    <form id="edit-blog-form" method="POST" action="{{ url_for('admin.edit_blog', blog_id=blog._id) }}">
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" id="csrf_token" value="">
        <div class="mb-3">
            <label for="title" class="form-label">标题</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ blog.title }}" required>
        </div>

        <div class="mb-3">
            <label class="form-label">是否对外显示</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="is_public" id="is_public_true" value="true" {% if blog.is_public is not false %}checked{% endif %}>
                <label class="form-check-label" for="is_public_true">
                    允许
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="is_public" id="is_public_false" value="false" {% if blog.is_public is false %}checked{% endif %}>
                <label class="form-check-label" for="is_public_false">
                    禁止
                </label>
            </div>
        </div>

        <div class="mb-3">
            <label for="content_md" class="form-label">Markdown 内容</label>
            <textarea class="form-control" id="content_md" name="content_md" rows="20" required>{{ blog.content_md }}</textarea>
        </div>
        
        <div class="d-flex justify-content-between">
            <div>
                <button type="submit" class="btn btn-primary">保存更改</button>
                <a href="{{ url_for('admin.manage_blogs_page') }}" class="btn btn-secondary">取消</a>
            </div>
            {% if blog.generation_details %}
            <button type="button" id="regenerate-btn" class="btn btn-info">再生成</button>
            {% endif %}
        </div>
    </form>
    {% else %}
    <p>正在加载博客内容...</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const regenerateBtn = document.getElementById('regenerate-btn');
    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', function() {
            const blogData = {{ blog | tojson }};
            const details = blogData.generation_details;
            if (!details) {
                alert('缺少生成信息，无法再次生成。');
                return;
            }

            const url = new URL("{{ url_for('admin.create_blog_page', _external=True) }}");
            url.searchParams.set('mode', details.mode || 'expand');
            url.searchParams.set('user_prompt', details.user_prompt || '');
            url.searchParams.set('system_prompt', details.system_prompt || '');
            
            if (details.university_ids && Array.isArray(details.university_ids)) {
                details.university_ids.forEach(id => {
                    url.searchParams.append('university_ids', id);
                });
            }
            
            window.open(url.toString(), '_blank');
        });
    }
});
</script>
{% endblock %}
