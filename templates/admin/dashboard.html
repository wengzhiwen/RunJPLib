{% extends "layout.html" %}

{% block title %}仪表盘{% endblock %}

{% block content %}
<h1>欢迎来到管理后台</h1>
<p>请从左侧菜单中选择一个选项开始。</p>

<hr>

<h2>数据一览</h2>

{% if error %}
    <div style="color: red; border: 1px solid red; padding: 15px; border-radius: 5px; background-color: #ffeeee;">
        <strong>错误:</strong> {{ error }}
    </div>
{% elif stats is defined %}
    <div class="stats-grid">
        <div class="stat-card">
            <h3>收录学校总数</h3>
            <p>{{ stats.university_count | default('N/A') }}</p>
        </div>
        <div class="stat-card">
            <h3>博客文章总数</h3>
            <p>{{ stats.blog_count | default('N/A') }}</p>
        </div>
        <div class="stat-card">
            <h3>24小时独立访客 (IP)</h3>
            <p>{{ stats.unique_ip_count_24h | default('N/A') }}</p>
        </div>
        <div class="stat-card">
            <h3>24小时学校页面浏览量</h3>
            <p>{{ stats.university_views_24h | default('N/A') }}</p>
        </div>
        <div class="stat-card">
            <h3>24小时博客页面浏览量</h3>
            <p>{{ stats.blog_views_24h | default('N/A') }}</p>
        </div>
        <div class="stat-card">
            <h3>24小时对话IP数</h3>
            <p>{{ stats.unique_chat_ip_count_24h | default('N/A') }}</p>
        </div>
        <div class="stat-card">
            <h3>24小时对话数</h3>
            <p>{{ stats.chat_count_24h | default('N/A') }}</p>
        </div>
    </div>
    
    <!-- 线程池状态 -->
    <h2>系统状态</h2>
    <div class="stats-grid">
        <div class="stat-card system-card blog-html-build-pool">
            <h3>博客HTML构建线程池</h3>
            <p id="blog-html-build-active-threads">加载中...</p>
            <small id="blog-html-build-details">最大: <span id="blog-html-build-max-workers">-</span> | 队列: <span id="blog-html-build-queue">-</span></small>
        </div>
        <div class="stat-card system-card admin-pool">
            <h3>Admin操作线程池</h3>
            <p id="admin-active-threads">加载中...</p>
            <small id="admin-details">最大: <span id="admin-max-workers">-</span> | 队列: <span id="admin-queue">-</span></small>
        </div>
        <div class="stat-card system-card user-access-log-pool">
            <h3>用户访问日志线程池</h3>
            <p id="user-access-log-active-threads">加载中...</p>
            <small id="user-access-log-details">最大: <span id="user-access-log-max-workers">-</span> | 队列: <span id="user-access-log-queue">-</span></small>
        </div>
        <div class="stat-card system-card summary">
            <h3>总计任务</h3>
            <p id="total-completed">加载中...</p>
            <small id="summary-stats">失败: <span id="total-failed">-</span> | 降级: <span id="total-fallback">-</span></small>
        </div>
    </div>
{% else %}
    <p>暂无统计数据。</p>
{% endif %}

<hr>

<h2>报名已过期的 Premium 学校</h2>
<div class="table-container">
    {% if expired_premium_universities %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>学校名称</th>
                    <th>报名截止日期</th>
                </tr>
            </thead>
            <tbody>
                {% for university in expired_premium_universities %}
                    <tr>
                        <td><a href="{{ url_for('admin.pdf_processor_page', university_name=university.university_name) }}">{{ university.university_name }}</a></td>
                        <td>{{ university.deadline.strftime('%Y-%m-%d') if university.deadline else 'N/A' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>暂无已过期的 Premium 学校。</p>
    {% endif %}
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .stat-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
        margin: 0 0 10px;
        font-size: 1.1em;
        color: #333;
    }
    .stat-card p {
        margin: 0;
        font-size: 2.2em;
        font-weight: bold;
        color: #0056b3;
    }
    .system-card {
        border-left: 4px solid #28a745;
    }
    .system-card.blog-html-build-pool {
        border-left-color: #007bff;
    }
    .system-card.admin-pool {
        border-left-color: #6f42c1;
    }
    .system-card.user-access-log-pool {
        border-left-color: #20c997;
    }
    .system-card.summary {
        border-left-color: #fd7e14;
    }
    .system-card small {
        display: block;
        margin-top: 5px;
        color: #6c757d;
        font-size: 0.9em;
    }
    .table-container {
        margin-top: 20px;
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th, .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
    }
    .data-table th {
        background-color: #f8f9fa;
        font-weight: bold;
        color: #333;
    }
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    .data-table tbody tr:hover {
        background-color: #f1f1f1;
    }
    .data-table a {
        color: #0056b3;
        text-decoration: none;
    }
    .data-table a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    connectSSE();
});

let eventSource;
let reconnectAttempts = 0;
const MAX_RECONNECT_DELAY = 30000; // 30 seconds

function connectSSE() {
    console.log("Connecting to dashboard SSE stream...");
    eventSource = new EventSource('/admin/api/dashboard-stream');

    eventSource.onopen = function() {
        console.log("Dashboard SSE connection established.");
        reconnectAttempts = 0;
    };

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateDashboard(data);
    };

    eventSource.onerror = function(err) {
        console.error("Dashboard EventSource failed:", err);
        eventSource.close();
        
        reconnectAttempts++;
        let delay = Math.min(MAX_RECONNECT_DELAY, 1000 * Math.pow(2, reconnectAttempts));
        delay += Math.random() * 1000;
        
        console.log(`Dashboard connection lost. Reconnecting in ${Math.round(delay / 1000)} seconds...`);
        
        // Update UI to show error state
        ['blog-html-build', 'admin', 'user-access-log'].forEach(pool => {
            const el = document.getElementById(`${pool}-active-threads`);
            if (el) {
                el.textContent = '断开';
                el.style.color = '#dc3545';
            }
        });
        
        setTimeout(connectSSE, delay);
    };
}

function updateDashboard(data) {
    if (!data) return;

    // 更新核心统计数据
    if (data.stats && !data.stats.error) {
        updateStatsCard('university_count', data.stats.university_count);
        updateStatsCard('blog_count', data.stats.blog_count);
        updateStatsCard('unique_ip_count_24h', data.stats.unique_ip_count_24h);
        updateStatsCard('university_views_24h', data.stats.university_views_24h);
        updateStatsCard('blog_views_24h', data.stats.blog_views_24h);
    }

    // 更新线程池状态
    if (data.pools) {
        updatePoolDisplay('blog-html-build', data.pools.blog_html_build_pool);
        updatePoolDisplay('admin', data.pools.admin_pool);
        updatePoolDisplay('user-access-log', data.pools.user_access_log_pool);
        
        // 更新总计
        const totalCompleted = document.getElementById('total-completed');
        const totalFailed = document.getElementById('total-failed');
        const totalFallback = document.getElementById('total-fallback');
        
        if (totalCompleted) totalCompleted.textContent = data.pools.completed_tasks || '0';
        if (totalFailed) totalFailed.textContent = data.pools.failed_tasks || '0';
        if (totalFallback) totalFallback.textContent = data.pools.sync_fallback_count || '0';
    }
}

function updateStatsCard(id, value) {
    // This is a bit tricky as the stats are rendered server-side.
    // We find the card by its h3 content and update the p tag.
    const h3s = document.querySelectorAll('.stat-card h3');
    const idToTextMap = {
        'university_count': '收录学校总数',
        'blog_count': '博客文章总数',
        'unique_ip_count_24h': '24小时独立访客 (IP)',
        'university_views_24h': '24小时学校页面浏览量',
        'blog_views_24h': '24小时博客页面浏览量'
    };

    for (let h3 of h3s) {
        if (h3.textContent === idToTextMap[id]) {
            const p = h3.nextElementSibling;
            if (p && p.tagName === 'P') {
                p.textContent = value !== undefined ? value : 'N/A';
            }
            break;
        }
    }
}

function updatePoolDisplay(poolName, poolData) {
    if (!poolData) return;
    
    const activeThreads = poolData.active_threads || 0;
    const maxWorkers = poolData.max_workers || 1;
    const queueSize = poolData.queue_size || 0;
    
    // 更新数值
    const activeEl = document.getElementById(`${poolName}-active-threads`);
    const maxEl = document.getElementById(`${poolName}-max-workers`);
    const queueEl = document.getElementById(`${poolName}-queue`);

    if (activeEl) activeEl.textContent = activeThreads;
    if (maxEl) maxEl.textContent = maxWorkers;
    if (queueEl) queueEl.textContent = queueSize;
    
    // 根据负载调整颜色
    if (activeEl) {
        const utilization = maxWorkers > 0 ? activeThreads / maxWorkers : 0;
        
        if (activeThreads === 0) {
            activeEl.style.color = '#6c757d'; // 灰色 - 空闲
        } else if (utilization < 0.7) {
            activeEl.style.color = '#28a745'; // 绿色 - 正常
        } else if (utilization < 1.0) {
            activeEl.style.color = '#ffc107'; // 黄色 - 繁忙
        } else {
            activeEl.style.color = '#dc3545'; // 红色 - 满载
        }
    }
}
</script>
{% endblock %}

