# 管理面板文档

本文档提供了RunJPLib项目管理面板的概述。

## 访问管理面板

管理面板位于应用程序的 `/admin` URL（例如：`http://localhost:5000/admin`）。

访问受到保护。您必须提供 `ACCESS_CODE` 才能登录。此代码通过 `ACCESS_CODE` 环境变量配置。

登录成功后，JWT 会存储在浏览器的本地存储中，用于验证后续的 API 请求。

## 功能特性

管理面板是一个单页应用程序，包含以下几个部分：

### 1. 仪表板

欢迎页面，也是管理后台的入口。仪表板提供以下信息：

#### 数据一览
- **收录学校总数**: 数据库中的大学招生信息数量
- **博客文章总数**: 已发布的博客文章数量  
- **24小时独立访客**: 最近24小时的独立IP访问数
- **24小时学校页面浏览量**: 大学信息页面的访问次数
- **24小时博客页面浏览量**: 博客页面的访问次数

#### 系统状态监控
实时显示三个独立线程池的运行状态：

- **博客更新线程池**: 处理Markdown到HTML的转换任务
  - 显示活跃线程数、最大线程数、队列大小
  - 颜色编码：绿色(正常)、黄色(繁忙)、红色(满载)
  
- **Admin操作线程池**: 处理管理员的编辑、保存操作
  - 确保长时间的Admin操作不会阻塞其他功能
  
- **Analytics日志线程池**: 处理访问日志的异步记录
  - 避免访问记录影响用户响应速度

- **总计任务**: 显示所有线程池的累计统计
  - 已处理任务数、失败任务数、降级执行次数

状态每5秒自动刷新，便于实时监控系统负载。

### 2. 招生信息

此部分允许直接管理招生信息相关的数据和生成流程：

-   **/admin/manage/universities**: 招生信息一览。表格会显示大学名称、Premium状态、报名截止日期等关键信息。
-   **/admin/pdf/processor**: 招生信息生成。上传PDF文件并自动处理生成招生信息。
-   **/admin/pdf/tasks**: 招生信息生成任务列表。查看PDF处理任务的进度和状态。

### 3. Blog

此部分允许管理博客文章：

-   **/admin/manage/blogs**: Blog一览。在此页面可以管理所有博客文章，并包含"新建博客"按钮。

在每个页面上，您可以：
-   **刷新列表**：获取并显示相应集合中所有项目的列表。
-   **清空所有数据**：删除集合中的所有文档。这是一个破坏性操作，需要确认。
-   对于每个项目，您可以：
    -   **查看**：在新标签页中打开该项目的用户页面。
    -   **编辑**：跳转到专门的编辑页面，可以直接修改文章的标题和Markdown内容。
    -   **删除**：从数据库中删除特定项目。

### 4. AI博客生成器 (`/admin/blog/create`)

管理后台的核心内容生成工具，允许管理员通过AI辅助，以多种模式创建博客文章。

-   **三种生成模式**:
    -   **材料扩展模式**: 基于一或多所大学的招生简章原文，结合用户提示词进行扩展创作。
    -   **对比分析模式**: 智能缩减并对比分析多所大学的材料，生成综合性的推荐或对比文章。
    -   **完全用户提示词模式**: 完全脱离大学材料，仅根据用户输入的提示词或草稿进行优化和创作。
-   **动态交互界面**:
    -   支持动态搜索并选择大学作为上下文材料。
    -   根据所选模式，自动填充和切换最优的系统提示词。
    -   UI会根据模式动态调整（例如，在“完全用户提示词模式”下隐藏大学选择功能）。

## API 端点

管理面板使用 `/admin/api/` 下的一组 API 端点。所有端点都受到保护，需要有效的 JWT Cookie。

-   `POST /admin/api/login`：使用访问码进行身份验证并返回 JWT。
-   `GET /admin/api/universities`：列出数据库中的大学。
-   `DELETE /admin/api/universities/<id>`：删除特定大学。
-   `DELETE /admin/api/universities`：清空大学集合。
-   `GET /admin/api/blogs`：列出数据库中的博客。
-   `DELETE /admin/api/blogs/<id>`：删除特定博客。
-   `DELETE /admin/api/blogs`：清空博客集合。
-   `GET /admin/api/universities/search`：根据查询参数 `q` 搜索大学，用于博客生成器。
-   `POST /admin/api/blog/generate`：核心AI生成接口，接收模式、大学ID、用户提示词和系统提示词。
-   `POST /admin/api/blog/save`：将最终生成的博客文章保存到数据库。

## 用户界面集成

以下用户界面已完全迁移至从 MongoDB 加载数据：

-   `/university/<name>/<deadline>`
-   `/blog/<title>`

系统不再包含任何回退到文件系统的逻辑。所有数据均由 MongoDB 提供。

新增了路由 `/pdf/resource/<resource_id>` 来从 GridFS 提供 PDF 文件。为了向后兼容，旧版路由 `/pdf/mongo/<item_id>` 仍然支持但已弃用。

## PDF 存储策略

系统现在使用 **GridFS** 进行 PDF 存储，而不是直接在 MongoDB 文档中嵌入二进制数据。这种方法：

- **解决文档大小限制**：GridFS 可以处理大于 MongoDB 16MB 文档限制的文件
- **提高安全性**：使用基于 UUID 的文件名防止注入攻击
- **保持用户体验**：用户仍然看到有意义的文件名（例如："東京学芸大学_20241219.pdf"）
- **优化性能**：没有嵌入的二进制数据，文档加载更快

### GridFS 文件结构
- **内部文件名**：UUID 格式（例如："550e8400-e29b-41d4-a716-446655440000"）
- **用户显示文件名**：在元数据中存储为 `original_filename`
- **文件标识**：通过元数据（`university_name` 和 `deadline`）
