# 变更日志 (CHANGELOG)

本文档记录了RunJPLib项目的重要更改，包括新功能、架构更新、安全改进等。

## [2025-01-27] - 修复PDF文件名显示问题：支持非英数字字符

### 🐛 问题修复
- **PDF文件名显示问题**: 修复了招生信息任务列表中PDF文件名列无法显示包含非英数字字符文件名的问题
- **字符过滤问题**: 原有的`escapeHtml`函数使用`textContent`属性，会过滤掉某些特殊字符
- **显示完整性**: 现在可以正确显示包含中文、日文、特殊符号等非英数字字符的PDF文件名

### 🔧 核心修复
- **HTML转义优化**: 重写了`escapeHtml`函数，使用更安全的字符替换方法
- **字符保留**: 保留所有非英数字字符，只转义HTML特殊字符（&, <, >, ", '）
- **安全性保持**: 在防止XSS攻击的同时，确保文件名完整显示

### 📁 文件更改
- **模板文件优化**：
  - `templates/admin/pdf_tasks.html`: 优化`escapeHtml`函数，支持非英数字字符
  - `templates/admin/pdf_task_detail.html`: 优化`escapeHtml`函数，添加文件名安全显示逻辑
- **JavaScript优化**：
  - 任务列表页面：文件名通过`escapeHtml`安全显示
  - 任务详情页面：文件名通过JavaScript安全处理后再显示

### ✨ 功能改进
- **文件名显示**: 现在可以正确显示包含中文、日文、韩文等非ASCII字符的PDF文件名
- **特殊符号支持**: 支持文件名中的括号、引号、连字符等特殊符号
- **用户体验**: 管理员可以准确识别上传的PDF文件，避免因文件名显示问题导致的混淆

### 🛠️ 技术细节
- **转义方法**: 使用正则表达式替换HTML特殊字符，而不是DOM操作
- **字符映射**:
  - `&` → `&amp;`
  - `<` → `&lt;`
  - `>` → `&gt;`
  - `"` → `&quot;`
  - `'` → `&#x27;`
- **兼容性**: 保持与现有代码的完全兼容，不影响其他功能

### 📊 测试建议
- 上传包含中文、日文、特殊符号的PDF文件，验证文件名正确显示
- 检查任务列表和任务详情页面的文件名显示是否完整
- 确认特殊字符不会导致页面渲染错误或安全问题

## [2025-01-27] - SSE数据库查询频率优化

### 🚨 问题描述
- **频繁数据库查询**：Admin后台的SSE（Server-Sent Events）流每2-3秒查询一次数据库
- **资源浪费**：dashboard_stream、task_stream、task_detail_stream持续高频访问MongoDB
- **CPU压力**：与MongoDB连接优化后的其他部分形成对比，SSE成为新的性能瓶颈

### 🔧 核心优化
- **查询频率调整**：将所有SSE流的数据库查询间隔从2-3秒增加到30秒
- **实时性平衡**：在保持数据实时性的同时，显著减少数据库访问频率
- **性能提升**：减少75%的SSE相关数据库查询，降低服务器负载

### 📁 文件更改
- **SSE流优化**：
  - `routes/admin.py`: 优化三个SSE流的查询频率
    - `dashboard_stream()`: 从3秒改为30秒
    - `task_stream()`: 从2秒改为30秒  
    - `task_detail_stream()`: 从2秒改为30秒

### ✨ 性能提升
- **数据库查询频率**：从每2-3秒一次降低到每30秒一次
- **查询次数减少**：减少75%的SSE相关数据库访问
- **服务器负载**：降低Admin后台的持续数据库压力
- **实时性保持**：30秒间隔仍能满足管理员的实时监控需求

### 🛠️ 技术细节
- **SSE流配置**：
  - dashboard_stream: 30秒间隔，用于推送核心统计数据和线程池状态
  - task_stream: 30秒间隔，用于推送任务列表和队列状态更新
  - task_detail_stream: 30秒间隔，用于推送单个任务的详细更新
- **数据变化检测**：SSE流仍保持原有的数据变化检测逻辑，只在数据真正变化时才推送

### 📊 监控建议
- 观察MongoDB连接日志中SSE相关查询的频率是否降低
- 监控Admin后台页面的响应性能是否提升
- 检查服务器CPU使用率是否进一步降低

## [2025-01-27] - MongoDB连接优化：解决CPU全满问题

### 🚨 问题描述
- **CPU全满问题**：生产服务器出现CPU使用率100%的问题，通过日志分析发现大量MongoDB连接ping操作
- **频繁连接创建**：`get_mongo_client()`函数每次调用都创建新连接并执行ping操作
- **无限循环调用**：TaskManager中的后台线程每分钟频繁调用数据库连接函数
- **资源浪费**：没有连接复用机制，每个数据库操作都重新建立连接

### 🔧 核心优化
- **连接池实现**：配置MongoDB连接池参数（maxPoolSize=10, minPoolSize=1, maxIdleTimeMS=300000等）
- **单例模式**：使用全局单例MongoDB客户端`_mongo_client`，避免重复创建连接
- **健康检查优化**：用`ismaster`命令替代`ping`进行健康检查，减少网络开销
- **线程安全**：添加线程锁确保多线程环境下的连接安全

### 📁 文件更改
- **核心优化**：
  - `utils/mongo_client.py`: 重构为连接池和单例模式，添加连接参数配置
  - `utils/task_manager.py`: 优化循环逻辑，动态调整检查频率，减少数据库调用
- **路由优化**：
  - `routes/index.py`: 替换所有`get_mongo_client()`调用为`get_db()`
  - `routes/blog.py`: 统一数据库访问接口
  - `app.py`: PDF服务数据库访问优化
  - `routes/admin.py`: 部分数据库访问优化

### ✨ 性能提升
- **CPU使用率**：显著降低，消除无用的ping操作
- **数据库连接数**：从无限制降低到最多10个活跃连接
- **响应时间**：连接复用减少建立连接的开销
- **系统稳定性**：避免连接泄漏和资源耗尽

### 🛠️ 技术细节
- **连接池配置**：
  - `maxPoolSize=10`: 最大连接池大小
  - `minPoolSize=1`: 最小连接池大小
  - `maxIdleTimeMS=300000`: 连接最大空闲时间（5分钟）
  - `waitQueueTimeoutMS=10000`: 等待连接超时时间
- **循环优化**：
  - 队列为空时才检查新任务，避免频繁数据库查询
  - 动态调整检查频率：有任务时30秒，空闲时5分钟
  - 添加指数退避策略处理连接错误

### 🐛 紧急Bug修复
- **MongoDB布尔值判断错误**: 修复了`if not db:`导致的`NotImplementedError`
- **正确的判断方式**: 改为`if db is None:`来检查数据库连接状态
- **GridFS连接优化**: 修复了PDF处理器中仍使用旧连接方式的问题
- **影响范围**: 修复了所有路由文件、工具文件、PDF处理器和Admin后台中的相同问题
- **修复统计**: 总共修复了20+处MongoDB连接相关的bug

### 📊 监控建议
- 使用`top`命令监控CPU使用率是否降低
- 通过`mongosh --eval "db.serverStatus().connections"`查看连接数是否稳定
- 检查应用日志是否还有频繁的ping日志

## [2025-08-28] - 修复仪表盘过期学校列表的逻辑错误

### 🐛 问题修复
- **修复过期逻辑**: 修复了仪表盘“报名已过期的 Premium 学校”列表的逻辑错误。此前，如果一所大学有多个报名批次，只要其中一个过期的批次是 Premium，即使有更新的、未过期的批次，该大学也会被错误地显示在列表中。
- **精确判断**: 新的查询逻辑确保只有当一所大学**所有版本中最晚的报名截止日期**也过期了，并且该大学**至少拥有一个 Premium 版本**时，它才会出现在列表中。这解决了类似“筑波大学”被错误报告的问题。

### 🔧 技术改进
- **重写聚合查询**: 在 `routes/admin.py` 中，重写了相关的 MongoDB 聚合查询。新查询会先按大学名称分组，找出每个大学的最晚截止日期和是否包含 Premium 版本，然后再根据这两个条件进行过滤，确保了逻辑的准确性。

### 📁 文件更改
- `routes/admin.py`: 更新了 `dashboard` 函数中的数据库查询逻辑。
- **代码格式化**: 对 `routes/admin.py` 文件执行了 `isort` 和 `yapf` 格式化。

## [2025-08-28] - 优化仪表盘过期学校列表逻辑

### ✨ 功能改进
- **聚合查询逻辑**: 优化了仪表盘“报名已过期的 Premium 学校”列表的生成逻辑。
- **按大学名称分组**: 新逻辑会先按大学名称对所有 Premium 学校进行分组。
- **判断最晚截止日期**: 在每个分组内，系统会找出最晚的报名截止日期（`max(deadline)`）。
- **精确过期判断**: 只有当一所大学**所有**的报名批次（即最晚的截止日期）都已经过期时，该大学才会出现在列表中。
- **排序优化**: 列表现在会按照最晚截止日期的升序排列（最旧的排在最前面）。
- **便捷操作**: 列表中的链接从“编辑大学”改为指向“招生信息生成”页面，并能自动填充大学名称，方便管理员快速为这些学校创建新的招生信息。

### 🔧 技术改进
- **MongoDB聚合管道**: 在 `routes/admin.py` 中，使用MongoDB的聚合管道（Aggregation Pipeline）代替了原有的 `find` 查询，以实现按名称分组和计算最大日期的复杂查询。

### 🐛 问题修复
- **修复误判问题**: 解决了之前版本中，只要有一个旧的报名批次过期，大学就会被列出的问题，使得列表的提醒功能更加准确。

### 📁 文件更改
- `routes/admin.py`: 更新了 `dashboard` 函数中的数据库查询逻辑。
- `templates/admin/dashboard.html`: 更新了列表中学校的链接，使其指向招生信息生成页面并传递大学名称。
- `templates/admin/pdf_processor.html`: 增加了JavaScript逻辑，以接收URL参数并自动填充大学名称输入框。
- **代码格式化**: 对 `routes/admin.py` 文件执行了 `isort` 和 `yapf` 格式化。

## [2025-08-28] - 数据库 `deadline` 字段类型迁移

### 🔧 核心变更
- **字段类型迁移**: 将 MongoDB 中 `universities` 集合的 `deadline` 字段（报名截止日期）的数据类型从 **字符串 (String)** 迁移为标准的 **BSON 日期类型 (Date)**。
- **数据一致性**: 此次迁移统一了日期数据的存储格式，为后续进行更精确的日期查询、排序和范围筛选奠定了基础。

### ✨ 功能改进
- **后台编辑功能增强**: 在 Admin 后台的“编辑招生信息”页面，新增了对“报名截止日期”的可视化编辑功能。管理员现在可以通过一个标准的日期选择器来修改该字段。
- **全链路日期对象支持**: 重构了应用程序的所有部分（数据创建、后台API、前台页面），以完全支持新的日期类型，移除了所有针对 `YYYYMMDD` 字符串格式的解析和格式化逻辑。

### 🛠️ 新增工具
- **数据迁移脚本**: 创建了一个新的一次性迁移脚本 `tools/migrate_deadline_to_date.py`。该脚本可以安全地将数据库中所有现存的字符串格式 `deadline` 转换为日期类型，并能处理多种常见的日期字符串格式。

### 📁 文件更改
- **数据迁移脚本**:
  - `tools/migrate_deadline_to_date.py`: 新增的迁移脚本。
- **数据写入层**:
  - `utils/pdf_processor.py`: 修改了新数据写入的逻辑，直接存入 `datetime` 对象。
- **后台管理 (Admin)**:
  - `routes/admin.py`: 更新了 `edit_university` 函数以处理日期输入；更新了 `get_universities` API 以返回 ISO 格式的日期字符串。
  - `templates/admin/edit_university.html`: 在编辑表单中增加了日期输入框。
  - `templates/admin/manage_universities.html`: 更新了前端 JavaScript，以正确格式化和显示日期。
- **前台展示**:
  - `routes/index.py`: 全面重构了 `get_university_details`, `university_route`, `get_latest_updates`, `get_sorted_universities_for_index`, 和 `sitemap_route` 函数，使用 `datetime` 对象进行查询和格式化。
- **代码格式化**:
  - 对所有修改过的 Python 文件 (`.py`) 执行了 `isort` 和 `yapf` 格式化。

## [2025-08-28] - 优化首页大学快速索引与文档完善

### ✨ 功能改进
- **按地区分组**: 在首页的“快速索引”部分，对“主要国公立”和“主要私立”两个分类下的大学，按照 `area`（地区）进行了分组显示。
- **提升可读性**: 通过地区分组，用户可以更方便地查找特定地区的学校，优化了用户体验。
- **保持其他分类不变**: 对于大学数量较少的分类，维持了原有的平铺显示方式，避免了不必要的层级结构。

### 🔧 技术改进
- **后端逻辑更新**: 修改了 `routes/index.py` 中的 `load_categories` 函数，在从CSV加载数据后，对指定的分类进行二次处理，生成按地区分组的嵌套数据结构。
- **自定义排序**: 地区分组的显示顺序按照“关东、关西、中部、东北、其他”的预设顺序进行排列，而非默认的字母顺序。
- **前端模板适配**: 更新了 `templates/index.html` 模板，使用 `{% if unis is mapping %}` 条件判断来区分不同数据结构，并为分组后的分类渲染带有地区标题的嵌套列表。

### 📚 文档
- **新增首页功能文档**: 创建了 `docs/homepage.md` 文件，详细说明了首页的页面结构、各功能模块（如大学列表、最新更新、快速索引等）的数据来源、后端逻辑、缓存策略和前端渲染方式。

### 📁 文件更改
- `routes/index.py`: 更新了分类数据的处理和排序逻辑。
- `templates/index.html`: 调整了快速索引部分的渲染逻辑。
- `docs/homepage.md`: 新增的文档文件。

## [2025-08-28] - 修复首页"最新更新"板块前端对齐问题

### 🐛 问题修复
- **左对齐问题**: 修复了首页"最新更新"板块中大学名称卡片的左对齐问题，确保与页面其他内容保持一致的视觉对齐效果。
- **布局重构**: 将原有的自定义CSS Grid布局重构为Bootstrap的响应式行列系统，解决了复杂的对齐计算问题。

### 🔧 技术改进
- **HTML结构优化**: 将 `<ul class="updates-list">` 改为 `<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-2">`，使用Bootstrap标准布局。
- **响应式设计**: 实现5列响应式网格布局，在不同屏幕尺寸下自动调整列数。
- **卡片系统**: 每个大学更新项都包装在Bootstrap的 `col` 和 `card` 中，保持一致的视觉风格。

### ✨ 用户体验提升
- **文字居中**: 实现大学名称在卡片中的完美纵向居中显示。
- **高度限制**: 限制"最新更新"板块最多显示3行内容，超出部分自动隐藏，保持页面整洁。
- **视觉优化**: 保留高级会员的黄色背景高亮效果，移除星星符号，界面更加简洁。

### 📐 尺寸优化
- **卡片高度**: 经过精确计算，设置卡片高度为45px，容器最大高度为165px，确保3行内容完整显示。
- **间距调整**: 使用Bootstrap的 `g-2` 间距系统，确保行间距为8px，布局紧凑美观。

### 📁 文件更改
- `templates/index.html`: 重构"最新更新"板块的HTML结构和CSS样式

## [2025-08-28] - 首页更新日志模块重构

### 🚀 新功能
- **动态更新模块**: 在首页新增“最新更新”模块，动态显示数据库中最近更新的20条大学招生信息。

### ✨ 功能改进
- **布局调整**: 将更新模块提升至搜索框正下方，使其更加醒目。
- **紧凑化设计**: 采用更紧凑的列表布局，优化了板块的垂直空间占用。
- **Premium高亮**: 为“最新更新”模块中的Premium大学增加了独特的视觉高亮效果（黄色边框和星号），以突出其重要性。

### 🗑️ 功能移除
- **移除静态日志**: 删除了原有的手动维护的静态HTML更新日志，由新的动态模块完全替代。

### 🔧 架构更改
- **后端数据接口**: 在 `routes/index.py` 中新增 `get_latest_updates` 函数，专门用于高效查询最新的20条更新数据。
- **前端渲染**: `templates/index.html` 中增加了新的渲染逻辑和对应的CSS样式，以支持新模块的展示。

## [2025-08-28] - 优化前端大学列表去重逻辑

### ✨ 功能改进
- **前端列表去重**: 优化了前端主页及详情页侧边栏的大学列表加载逻辑。
- **采用聚合管道**: 修改 `routes/index.py` 中的 `get_sorted_universities_for_index` 函数，通过使用MongoDB聚合管道在数据库查询层面实现大学列表的去重。
- **保证数据最新**: 新逻辑确保每个大学只返回其最新（或`is_premium`）的一条记录，解决了因存在多份历史数据而导致前端列表重复的问题。
- **提升用户体验**: 消除了重复链接给普通用户带来的困扰，同时不影响Admin后台查看所有原始数据的功能。

## [2025-08-27] - 线程池架构重构与性能优化

### 🚀 新功能
- **独立线程池架构**: 重构为三个独立的线程池，避免不同类型操作的相互干扰：
  - **Analytics线程池**: 处理高频访问日志记录（默认6线程）
  - **博客更新线程池**: 处理中频HTML重建操作（默认8线程）
  - **Admin操作线程池**: 处理低频但重要的管理操作（默认4线程）
- **实时线程监控**: Admin仪表盘新增线程池状态监控，包括：
  - 每个线程池的活跃线程数
  - 队列大小和任务统计
  - 颜色编码的负载指示（绿色-正常、黄色-繁忙、红色-满载）
  - 每5秒自动刷新状态
- **智能降级机制**: 线程池满载时自动切换为同步执行，确保操作不丢失

### 🔧 架构更改
- **新增线程池管理器**: 创建 `utils/thread_pool_manager.py` 统一管理所有线程池
- **Analytics异步化**: `utils/analytics.py` 的访问日志记录从同步改为异步执行
- **Admin操作优化**: Admin的大学信息编辑、博客保存等操作支持异步执行
- **线程回收机制**: 使用 `ThreadPoolExecutor` 确保线程正确回收，避免资源泄漏

### 🛡️ 线程安全改进
- **消除线程泄漏**: 修复博客HTML更新中的无限制线程创建问题
- **守护线程管理**: 所有后台线程正确设置为守护线程，确保应用优雅退出
- **资源隔离**: 不同类型操作使用独立线程池，避免资源竞争

### ⚙️ 环境配置
- **新增环境变量支持**:
  - `BLOG_UPDATE_THREAD_POOL_SIZE`: 博客更新线程池大小（默认8）
  - `ADMIN_THREAD_POOL_SIZE`: Admin操作线程池大小（默认4）
  - `ANALYTICS_THREAD_POOL_SIZE`: Analytics日志线程池大小（默认6）

### 📊 性能优化
- **访问日志异步化**: 页面访问记录不再阻塞用户响应，显著提升响应速度
- **博客HTML重建优化**: 使用线程池限制并发数，避免资源过度消耗
- **Admin操作并发**: 长时间的Admin操作（如博客生成）不再阻塞其他用户功能

### 🔧 技术债务清理
- **移除无管理线程**: 修复了 `routes/blog.py` 中的线程泄漏问题
- **统一异常处理**: 所有线程池操作增加完善的错误处理和日志记录
- **代码质量**: 修复所有linting错误，提升代码质量

### 📁 文件更改
- `utils/thread_pool_manager.py`: 新增线程池管理器
- `utils/analytics.py`: 重构为异步执行
- `routes/blog.py`: 修复线程泄漏，使用线程池
- `routes/admin.py`: Admin操作支持异步执行
- `templates/admin/dashboard.html`: 新增线程池状态监控界面

### 🐛 问题修复
- **生产环境线程泄漏**: 解决了277并发连接导致的线程爆炸问题
- **应用无法退出**: 修复了非守护线程阻止应用正常关闭的问题
- **资源竞争**: 消除了不同操作类型之间的线程池资源竞争

## [2025-08-27] - 优化Admin后台任务状态更新

### ✨ 功能改进
- **实时更新**: 将Admin后台的“招生信息生成任务列表”、“任务详情”及“仪表盘”页面的状态更新机制从轮询API，改为使用SSE (Server-Sent Events) 技术。
- **健壮的重连机制**: 为所有SSE连接实现了带有指数退避策略的自动重连功能，解决了因网络波动或服务器连接超时导致的更新中断问题。
- **提升用户体验**: 移除了页面自动刷新和轮询带来的闪烁和白屏，现在任务状态、进度、日志及仪表盘统计数据都可以实时、平滑地更新，极大提升了操作体验。
- **降低服务器负载**: 通过使用长连接推送代替客户端主动轮询，减少了无意义的HTTP请求数量，降低了服务器和网络的负载。

### 🔧 架构更改
- **新增SSE路由**: 在 `routes/admin.py` 中增加了三个新的SSE端点：
  - `/admin/api/dashboard-stream`: 用于向仪表盘推送核心统计数据和线程池状态。
  - `/admin/api/pdf/task-stream`: 用于向任务列表页推送所有任务的概览和队列状态。
  - `/admin/api/pdf/task-stream/<task_id>`: 用于向任务详情页推送单个任务的详细信息和日志。
- **前端重构**:
  - 修改了 `templates/admin/dashboard.html`, `templates/admin/pdf_tasks.html` 和 `templates/admin/pdf_task_detail.html` 中的JavaScript逻辑。
  - 使用浏览器原生的 `EventSource` API来订阅后端的SSE事件流。
  - 移除了所有基于 `setInterval` 的轮询代码。

## [2025-08-27] - 优化招生信息管理功能

### ✨ 功能改进
- **在线编辑**: 在“招生信息一览”页面为每条记录增加了“编辑”功能，允许管理员直接修改大学名称、Premium状态和基础分析报告。
- **优化排序**: “招生信息一览”页面的数据现在默认按创建时间逆序排列，最新的信息会显示在最前面。

### 🔧 架构更改
- **新增编辑路由**: 在 `routes/admin.py` 中添加了 `/admin/edit_university/<university_id>` 路由，用于处理大学信息的编辑和保存。
- **新增HTML模板**: 创建了 `templates/admin/edit_university.html` 模板文件，用于渲染编辑表单。

## [2025-01-13] - Admin后台菜单结构优化

### 🎨 界面优化
- **菜单重新组织**: 将Admin后台菜单按功能分组，增加了两个一级分组：
  - **招生信息分组**: 包含招生信息一览、招生信息生成、招生信息生成任务列表
  - **Blog分组**: 包含Blog一览
- **菜单项名称更新**:
  - "大学管理" → "招生信息一览"
  - "PDF处理器" → "招生信息生成"
  - "处理任务" → "招生信息生成任务列表"
  - "博客管理" → "Blog一览"
- **新建博客按钮移动**: 将"新建博客"从侧边栏菜单移动到Blog一览页面上方的按钮位置

### 📄 文档更新
- **管理面板文档**: 更新 `admin_panel.md` 以反映新的菜单结构和分组
- **数据管理工具文档**: 更新 `数据管理工具.md` 中的相关描述
- **博客创建指南**: 更新 `blog_creator_usage.md` 中的使用流程说明

## [2025-01-13] - 新增大学招生信息处理器

### 🚀 新功能
- **大学招生信息处理器**: 新增完整的PDF处理功能
  - 支持PDF文件上传和自动处理
  - 基于Buffalo工作流程管理器的五步处理流程：
    1. PDF转图片 (pdf2image)
    2. OCR识别 (OpenAI Vision)
    3. 翻译 (日文转中文)
    4. 分析 (生成招生信息报告)
    5. 发布 (保存到MongoDB)
  - Admin后台管理界面，包括：
    - 招生信息生成页面 (`/admin/pdf/processor`)
    - 招生信息生成任务列表页面 (`/admin/pdf/tasks`)
    - 任务详情页面 (`/admin/pdf/task/<task_id>`)
  - 异步任务队列系统，支持任务并发管理
  - 实时任务进度跟踪和日志查看
  - 自动清理7天前的过期任务
  - **任务重启功能**: 支持从任意步骤重启已完成或失败的任务

### 🔧 技术改进
- 新增MongoDB `processing_tasks` 集合及相关索引
- 添加任务管理器 (`TaskManager`) 支持异步处理
- 集成OCR、翻译、分析工具到主项目
- 支持临时文件管理和自动清理
- 新增相关依赖：`pdf2image`, `pandas`, `natsort`, `tqdm`

### 📋 API变更
- 新增Admin API端点：
  - `POST /admin/api/pdf/upload` - 上传PDF并创建任务
  - `GET /admin/api/pdf/tasks` - 获取任务列表
  - `GET /admin/api/pdf/task/<task_id>` - 获取任务详情
  - `GET /admin/api/pdf/queue_status` - 获取队列状态
  - `POST /admin/api/pdf/task/<task_id>/restart` - 从指定步骤重启任务

### ⚙️ 环境变量要求
- `PDF_PROCESSOR_TEMP_DIR` - PDF处理临时目录 (可选，默认: temp/pdf_processing)
- `OCR_DPI` - OCR图片DPI (可选，默认: 150)
- `OCR_MODEL_NAME` - OCR模型名称 (可选，默认: gpt-4o-mini)
- `OPENAI_TRANSLATE_MODEL` - 翻译模型名称 (可选，默认: gpt-4o-mini)
- `OPENAI_ANALYSIS_MODEL` - 分析模型名称 (可选，默认: gpt-4o-mini)
- `TRANSLATE_TERMS_FILE` - 翻译术语文件路径 (可选)
- `ANALYSIS_QUESTIONS_FILE` - 分析问题文件路径 (可选)

## [2025-08-26] - 为Admin后台增加博客编辑功能

### 🚀 新功能
- **博客编辑界面**: 在管理后台的"Blog一览"页面，为每篇博客增加了一个"编辑"按钮。
- **在线编辑**: 点击“编辑”按钮会跳转到 `/admin/blog/edit/<blog_id>` 页面，管理员可以直接在网页表单中修改博客的标题和Markdown原文。
- **保存与更新**: 编辑完成后，点击“保存更改”会将更新后的内容写回MongoDB，并更新 `md_last_updated` 时间戳。

### 🔧 架构更改
- **新增编辑路由**: 在 `routes/admin.py` 中添加了 `/admin/blog/edit/<blog_id>` 路由，支持 `GET` 方法（用于展示编辑表单）和 `POST` 方法（用于处理表单提交和数据更新）。
- **新增HTML模板**: 创建了 `templates/admin/edit_blog.html` 模板文件，用于渲染博客编辑表单。

### ✨ 功能改进
- **用户体验**: 管理员现在可以快速修复或更新已发布的博客文章，而无需手动操作数据库或重新创建文章。
- **代码格式化**: 对 `routes/admin.py` 文件使用了项目指定的 `yapf` 和 `isort` 工具进行了代码格式化。

## [2025-08-26] - Admin仪表盘数据统计实装

### 🚀 新功能
- **仪表盘数据统计**: 为管理后台的仪表盘页面添加了核心数据统计功能，提供以下实时指标：
    1.  收录的学校入学信息总数。
    2.  发布的博客文章总数。
    3.  最近24小时的独立访客IP数量。
    4.  最近24小时入学信息页面的总访问次数。
    5.  最近24小时博客页面的总访问次数。

### 🔧 架构更改
- **新增 `access_logs` 集合**: 在 MongoDB 中引入了新的 `access_logs` 集合，用于记录每一次对公开页面（大学信息页、博客页）的访问。
- **访问日志记录器**: 创建了新的工具模块 `utils/analytics.py`，封装了 `log_access` 函数，用于向 `access_logs` 集合中插入访问记录。
- **路由集成**: 在大学详情页 (`routes/index.py`) 和博客详情页 (`routes/blog.py`) 的路由处理函数中集成了 `log_access` 调用，以实现自动访问记录。
- **索引优化**: 为 `access_logs` 集合添加了 `(timestamp, page_type)` 复合索引，以确保仪表盘数据聚合查询的高性能。

### ✨ 功能改进
- **动态仪表盘**: `routes/admin.py` 中的 `dashboard` 路由现在会执行聚合查询，并将统计结果动态渲染到 `templates/admin/dashboard.html` 模板中。
- **前端展示**: 更新了仪表盘的前端页面，使用清晰的卡片式布局展示各项统计数据，并增加了简单的CSS样式以提升视觉效果。

## [2025-08-26] - 新增AI博客生成器功能

### 🚀 新功能
- **AI博客生成器**: 在管理后台新增“新建博客”功能 (`/admin/blog/create`)，允许管理员通过AI辅助快速创建博客文章。
- **大学数据集成**: 管理员可以选择一篇或多篇大学的招生简章原文作为AI撰写博客的基础材料。
- **灵活的提示词**: 提供用户提示词和可修改的系统提示词输入框，给予管理员对生成内容的高度控制。
- **前端集成**: 实现了动态的大学搜索、已选大学标签化管理、内容生成和保存的完整前端交互，无需刷新页面。

### 🔧 架构更改
- **新增AI工具模块**: 创建了 `utils/blog_generator.py` 模块，封装了与 `openai-agents` 库的交互逻辑，将AI功能与路由代码解耦。
- **新增Admin API**: 在 `routes/admin.py` 中添加了三个新的API端点：
    - `GET /api/universities/search`: 用于前端动态搜索大学。
    - `POST /api/blog/generate`: 用于调用AI生成博客内容。
    - `POST /api/blog/save`: 用于将最终的博客文章保存到MongoDB。
- **依赖更新**: 在 `requirements.txt` 中添加了 `openai-agents`, `buffalo-workflow`, `nest_asyncio` 等AI相关依赖。

### 📚 文档
- **更新CHANGELOG**: 在此文件中记录了新功能的详细信息。
- **新增功能文档**: 创建了 `docs/blog_creator.md`（注：此为需求文档，同时也可作为功能说明）。



## [2025-08-26] - 移除批量博客上传功能

### 🗑️ 功能移除
- **移除批量博客上传**: 从管理后台的仪表盘中彻底移除了批量上传博客的功能。此功能原用于从本地文件系统迁移数据，现已不再需要。
- **代码清理**: 删除了后端的 `/api/upload/blogs` 路由及其处理函数，并简化了仪表盘页面的前端代码。

### 📚 文档
- 更新了 `admin_panel.md` 和 `数据管理工具.md`，以移除所有关于批量博客上传功能的描述。

## [2025-08-26] - 优化大学数据管理界面

### ✨ 功能改进
- **Premium状态显示**: 在后台的"招生信息一览"页面，现在会以徽章形式明确展示每个大学的 `is_premium` 状态（是/否），便于管理员快速识别。

### 🔧 架构更改
- **移除批量更新脚本**: 删除了 `tools/set_is_premium_from_csv.py` 脚本。`is_premium` 状态的设置将通过外部方式单独进行，不再作为项目内的批量功能，简化了项目的工具集。

### 📚 文档
- 更新了 `admin_panel.md` 和 `mongoDB_design.md`，以反映 `is_premium` 字段的显示和定义。

## [2025-08-26] - 核心数据迁移与后台重构

### 🔧 架构更改
- **大学数据源迁移**: 彻底移除对本地 `pdf_with_md*` 文件夹的依赖。所有大学招生信息现在完全从 MongoDB 获取，移除了文件系统的备用逻辑。
- **后台功能调整**:
    - **废弃大学数据上传**: 移除了管理后台从本地文件夹上传大学数据的功能，因为源文件将被删除。
    - **后台页面拆分**: 将原统一的"数据管理"页面拆分为独立的"招生信息一览" (`/admin/manage/universities`) 和"Blog一览" (`/admin/manage/blogs`) 页面，使职责更清晰。
- **认证机制强化**:
    - **Cookie认证**: 将后台认证从依赖前端 `localStorage` 和 `Authorization` 头的方式，切换为使用更安全、更标准的 `HttpOnly` Cookie 认证。
    - **智能认证装饰器**: 重写了 `@admin_required` 装饰器，使其能区分页面请求（失败时重定向到登录页）和API请求（失败时返回JSON错误），彻底解决了认证流程中的逻辑错误和循环重定向问题。

### 📁 文件更改
- `routes/index.py`: 完全重写，移除了 `UniversityCache` 和所有文件I/O，改为纯MongoDB数据获取，并引入了缓存机制。
- `routes/admin.py`: 移除了所有大学文件上传相关的路由和函数；重写了认证装饰器和登录API。
- `app.py`: 移除了废弃的、基于文件的PDF服务路由。
- `templates/admin/`:
    - 创建了新的基础布局 `layout.html`，统一了后台风格和共享脚本。
    - `dashboard.html` 被重构为继承自 `layout.html`，并移除了大学上传UI。
    - `login.html` 被简化，并修复了认证流程中的异步bug。
- `docs/`: 更新了 `mongoDB_design.md`, `admin_panel.md`, `CHANGELOG.md` 等多个文档以反映架构变化。

### 📊 性能优化
- **大学列表缓存**: 为 `get_sorted_universities` 函数增加了基于时间的内存缓存，减少了首页加载时的数据库查询。
- **分类加载优化**: `load_categories` 函数现在一次性从数据库获取所有大学名称，避免了对每条分类的重复查询。

## [2025-08-26] - 博客模块重构与优化

### 🔧 架构更改
- **博客数据源**: 将博客文章的存储从本地文件系统 (`/blogs` 目录) 迁移至 MongoDB (`blogs` 集合)。
- **移除文件缓存**: 删除了与博客文件系统相关的缓存机制 (`BlogCache`)，包括文件哈希计算和定时检查更新的逻辑。
- **代码简化**: 重构了 `routes/blog.py`，移除了所有文件I/O操作，现在完全依赖MongoDB进行数据查询。

### 📊 性能优化
- **应用层缓存**: 为博客列表 (`get_all_blogs`) 添加了基于时间的内存缓存（`TTLCache`，有效期5分钟），显著减少了对数据库的重复查询，提高了页面加载速度。
- **延迟渲染 (Lazy Rebuild)**: 实现了Markdown内容的按需渲染机制。HTML只在内容过时或不存在时生成一次，并异步更新回数据库，避免了每次请求都进行CPU密集型的转换操作。
- **查询效率**: 使用MongoDB的聚合查询 (`$sample`) 来高效获取随机博客文章，替代了之前读取所有文件再随机选择的方式。
- **减少I/O**: 消除了对文件系统的频繁读操作和状态检查，降低了磁盘I/O开销。

### 📁 文件更改
- `routes/blog.py`: 完全重写以使用MongoDB，并集成了缓存和延迟渲染逻辑。
- `utils/cache.py`: 新增文件，用于统一管理应用级别的缓存策略。
- `docs/blog_data_source_update.md`: 更新了技术文档，详细说明了数据源迁移和后续的性能优化措施。

### 🔄 向后兼容
- **API接口**: 所有面向用户的博客URL (`/blog`, `/blog/<title>`) 保持不变。
- **功能模块**: 首页的随机博客推荐和站点地图 (`sitemap.xml`) 的博客列表功能保持不变，现在由MongoDB和缓存驱动。

## [2025-01-27] - GridFS架构重构

### 🚀 新功能
- **GridFS PDF存储**：将PDF文件从MongoDB文档迁移到GridFS
- **安全文件名策略**：使用UUID作为GridFS内部文件名，防止注入攻击
- **智能文件去重**：通过元数据检测重复文件，避免重复存储

### 🔧 架构更改
- **PDF存储方式**：从文档内嵌Binary改为GridFS引用
- **文件名管理**：内部使用UUID，用户显示使用原始文件名
- **元数据结构**：新增`pdf_file_id`字段，移除`original_pdf`字段

### 🛡️ 安全改进
- **防止文件名注入**：GridFS文件名使用随机UUID
- **元数据验证**：通过`university_name`和`deadline`验证文件身份
- **HTTP头安全**：避免非ASCII字符在响应头中的编码问题

### 📁 文件更改
- `routes/admin.py`: 上传逻辑使用GridFS
- `app.py`: PDF服务从GridFS读取文件
- `tools/migrate_to_gridfs.py`: 数据迁移脚本
- `docs/mongoDB_design.md`: 更新数据库设计
- `docs/GridFS_migration_guide.md`: 新增迁移指南
- `docs/admin_panel.md`: 更新管理面板文档
- `docs/数据管理工具.md`: 更新技术设计文档

### 🐛 问题修复
- **文档大小限制**：解决MongoDB 16MB文档大小限制
- **PDF服务错误**：修复HTTP响应头编码问题
- **文件上传失败**：解决"update command document too large"错误

### 📊 性能优化
- **文档查询速度**：移除大二进制数据，查询更快
- **内存使用**：减少MongoDB内存占用
- **网络传输**：PDF按需加载，减少不必要的数据传输

### 🔄 向后兼容
- **现有路由**：保持所有现有API端点不变
- **文件回退**：MongoDB无数据时自动回退到文件系统
- **迁移支持**：提供完整的迁移脚本和指南

## [2025-01-26] - MongoDB集成

### 🚀 新功能
- **MongoDB支持**：集成MongoDB作为主要数据存储
- **Admin管理面板**：提供数据上传、管理和查看功能
- **JWT认证**：管理员登录和API保护

### 🔧 架构更改
- **数据存储**：从文件系统迁移到MongoDB
- **路由重构**：支持MongoDB和文件系统双重数据源
- **缓存机制**：实现大学信息的智能缓存

### 📁 文件更改
- `routes/admin.py`: 新增管理面板路由
- `routes/index.py`: 支持MongoDB数据源
- `app.py`: 新增PDF服务路由
- `utils/mongo_client.py`: MongoDB连接工具

## 技术债务

### 🔴 高优先级
- 无

### 🟡 中优先级
- 考虑添加PDF文件压缩功能
- 实现GridFS文件的定期清理策略
- 添加文件上传进度监控

### 🟢 低优先级
- 优化GridFS查询性能
- 添加文件访问统计
- 实现文件版本管理

## 已知问题

### 🐛 已修复
- MongoDB文档大小限制问题
- HTTP响应头编码问题
- PDF文件上传失败问题

### ⚠️ 待观察
- GridFS在大文件下的性能表现
- 迁移脚本在大量数据下的稳定性

## 升级指南

### 从文件系统升级到GridFS
1. 备份现有MongoDB数据
2. 运行迁移脚本：`python tools/migrate_to_gridfs.py`
3. 验证迁移结果
4. 清理备份数据（可选）

### 从旧版本升级
1. 更新代码到最新版本
2. 检查MongoDB连接配置
3. 运行必要的迁移脚本
4. 测试所有功能

## 贡献指南

- 所有架构更改必须在`docs/`目录下记录
- 新功能需要更新相应的文档
- 重大更改需要更新此变更日志
- 遵循现有的代码风格和架构模式