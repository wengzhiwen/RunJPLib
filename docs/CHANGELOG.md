# 变更日志 (CHANGELOG)

本文档记录了RunJPLib项目的重要更改，包括新功能、架构更新、安全改进等。

## [2025-08-26] - 新增AI博客生成器功能

### 🚀 新功能
- **AI博客生成器**: 在管理后台新增“新建博客”功能 (`/admin/blog/create`)，允许管理员通过AI辅助快速创建博客文章。
- **大学数据集成**: 管理员可以选择一篇或多篇大学的招生简章原文作为AI撰写博客的基础材料。
- **灵活的提示词**: 提供用户提示词和可修改的系统提示词输入框，给予管理员对生成内容的高度控制。
- **前端集成**: 实现了动态的大学搜索、已选大学标签化管理、内容生成和保存的完整前端交互，无需刷新页面。

### 🔧 架构更改
- **新增AI工具模块**: 创建了 `utils/blog_generator.py` 模块，封装了与 `openai-agents` 库的交互逻辑，将AI功能与路由代码解耦。
- **新增Admin API**: 在 `routes/admin.py` 中添加了三个新的API端点：
    - `GET /api/universities/search`: 用于前端动态搜索大学。
    - `POST /api/blog/generate`: 用于调用AI生成博客内容。
    - `POST /api/blog/save`: 用于将最终的博客文章保存到MongoDB。
- **依赖更新**: 在 `requirements.txt` 中添加了 `openai-agents`, `buffalo-workflow`, `nest_asyncio` 等AI相关依赖。

### 📚 文档
- **更新CHANGELOG**: 在此文件中记录了新功能的详细信息。
- **新增功能文档**: 创建了 `docs/blog_creator.md`（注：此为需求文档，同时也可作为功能说明）。



## [2025-08-26] - 移除批量博客上传功能

### 🗑️ 功能移除
- **移除批量博客上传**: 从管理后台的仪表盘中彻底移除了批量上传博客的功能。此功能原用于从本地文件系统迁移数据，现已不再需要。
- **代码清理**: 删除了后端的 `/api/upload/blogs` 路由及其处理函数，并简化了仪表盘页面的前端代码。

### 📚 文档
- 更新了 `admin_panel.md` 和 `数据管理工具.md`，以移除所有关于批量博客上传功能的描述。

## [2025-08-26] - 优化大学数据管理界面

### ✨ 功能改进
- **Premium状态显示**: 在后台的“大学管理”页面，现在会以徽章形式明确展示每个大学的 `is_premium` 状态（是/否），便于管理员快速识别。

### 🔧 架构更改
- **移除批量更新脚本**: 删除了 `tools/set_is_premium_from_csv.py` 脚本。`is_premium` 状态的设置将通过外部方式单独进行，不再作为项目内的批量功能，简化了项目的工具集。

### 📚 文档
- 更新了 `admin_panel.md` 和 `mongoDB_design.md`，以反映 `is_premium` 字段的显示和定义。

## [2025-08-26] - 核心数据迁移与后台重构

### 🔧 架构更改
- **大学数据源迁移**: 彻底移除对本地 `pdf_with_md*` 文件夹的依赖。所有大学招生信息现在完全从 MongoDB 获取，移除了文件系统的备用逻辑。
- **后台功能调整**:
    - **废弃大学数据上传**: 移除了管理后台从本地文件夹上传大学数据的功能，因为源文件将被删除。
    - **后台页面拆分**: 将原统一的“数据管理”页面拆分为独立的“大学管理” (`/admin/manage/universities`) 和“博客管理” (`/admin/manage/blogs`) 页面，使职责更清晰。
- **认证机制强化**:
    - **Cookie认证**: 将后台认证从依赖前端 `localStorage` 和 `Authorization` 头的方式，切换为使用更安全、更标准的 `HttpOnly` Cookie 认证。
    - **智能认证装饰器**: 重写了 `@admin_required` 装饰器，使其能区分页面请求（失败时重定向到登录页）和API请求（失败时返回JSON错误），彻底解决了认证流程中的逻辑错误和循环重定向问题。

### 📁 文件更改
- `routes/index.py`: 完全重写，移除了 `UniversityCache` 和所有文件I/O，改为纯MongoDB数据获取，并引入了缓存机制。
- `routes/admin.py`: 移除了所有大学文件上传相关的路由和函数；重写了认证装饰器和登录API。
- `app.py`: 移除了废弃的、基于文件的PDF服务路由。
- `templates/admin/`:
    - 创建了新的基础布局 `layout.html`，统一了后台风格和共享脚本。
    - `dashboard.html` 被重构为继承自 `layout.html`，并移除了大学上传UI。
    - `login.html` 被简化，并修复了认证流程中的异步bug。
- `docs/`: 更新了 `mongoDB_design.md`, `admin_panel.md`, `CHANGELOG.md` 等多个文档以反映架构变化。

### 📊 性能优化
- **大学列表缓存**: 为 `get_sorted_universities` 函数增加了基于时间的内存缓存，减少了首页加载时的数据库查询。
- **分类加载优化**: `load_categories` 函数现在一次性从数据库获取所有大学名称，避免了对每条分类的重复查询。

## [2025-08-26] - 博客模块重构与优化

### 🔧 架构更改
- **博客数据源**: 将博客文章的存储从本地文件系统 (`/blogs` 目录) 迁移至 MongoDB (`blogs` 集合)。
- **移除文件缓存**: 删除了与博客文件系统相关的缓存机制 (`BlogCache`)，包括文件哈希计算和定时检查更新的逻辑。
- **代码简化**: 重构了 `routes/blog.py`，移除了所有文件I/O操作，现在完全依赖MongoDB进行数据查询。

### 📊 性能优化
- **应用层缓存**: 为博客列表 (`get_all_blogs`) 添加了基于时间的内存缓存（`TTLCache`，有效期5分钟），显著减少了对数据库的重复查询，提高了页面加载速度。
- **延迟渲染 (Lazy Rebuild)**: 实现了Markdown内容的按需渲染机制。HTML只在内容过时或不存在时生成一次，并异步更新回数据库，避免了每次请求都进行CPU密集型的转换操作。
- **查询效率**: 使用MongoDB的聚合查询 (`$sample`) 来高效获取随机博客文章，替代了之前读取所有文件再随机选择的方式。
- **减少I/O**: 消除了对文件系统的频繁读操作和状态检查，降低了磁盘I/O开销。

### 📁 文件更改
- `routes/blog.py`: 完全重写以使用MongoDB，并集成了缓存和延迟渲染逻辑。
- `utils/cache.py`: 新增文件，用于统一管理应用级别的缓存策略。
- `docs/blog_data_source_update.md`: 更新了技术文档，详细说明了数据源迁移和后续的性能优化措施。

### 🔄 向后兼容
- **API接口**: 所有面向用户的博客URL (`/blog`, `/blog/<title>`) 保持不变。
- **功能模块**: 首页的随机博客推荐和站点地图 (`sitemap.xml`) 的博客列表功能保持不变，现在由MongoDB和缓存驱动。

## [2025-01-27] - GridFS架构重构

### 🚀 新功能
- **GridFS PDF存储**：将PDF文件从MongoDB文档迁移到GridFS
- **安全文件名策略**：使用UUID作为GridFS内部文件名，防止注入攻击
- **智能文件去重**：通过元数据检测重复文件，避免重复存储

### 🔧 架构更改
- **PDF存储方式**：从文档内嵌Binary改为GridFS引用
- **文件名管理**：内部使用UUID，用户显示使用原始文件名
- **元数据结构**：新增`pdf_file_id`字段，移除`original_pdf`字段

### 🛡️ 安全改进
- **防止文件名注入**：GridFS文件名使用随机UUID
- **元数据验证**：通过`university_name`和`deadline`验证文件身份
- **HTTP头安全**：避免非ASCII字符在响应头中的编码问题

### 📁 文件更改
- `routes/admin.py`: 上传逻辑使用GridFS
- `app.py`: PDF服务从GridFS读取文件
- `tools/migrate_to_gridfs.py`: 数据迁移脚本
- `docs/mongoDB_design.md`: 更新数据库设计
- `docs/GridFS_migration_guide.md`: 新增迁移指南
- `docs/admin_panel.md`: 更新管理面板文档
- `docs/数据管理工具.md`: 更新技术设计文档

### 🐛 问题修复
- **文档大小限制**：解决MongoDB 16MB文档大小限制
- **PDF服务错误**：修复HTTP响应头编码问题
- **文件上传失败**：解决"update command document too large"错误

### 📊 性能优化
- **文档查询速度**：移除大二进制数据，查询更快
- **内存使用**：减少MongoDB内存占用
- **网络传输**：PDF按需加载，减少不必要的数据传输

### 🔄 向后兼容
- **现有路由**：保持所有现有API端点不变
- **文件回退**：MongoDB无数据时自动回退到文件系统
- **迁移支持**：提供完整的迁移脚本和指南

## [2025-01-26] - MongoDB集成

### 🚀 新功能
- **MongoDB支持**：集成MongoDB作为主要数据存储
- **Admin管理面板**：提供数据上传、管理和查看功能
- **JWT认证**：管理员登录和API保护

### 🔧 架构更改
- **数据存储**：从文件系统迁移到MongoDB
- **路由重构**：支持MongoDB和文件系统双重数据源
- **缓存机制**：实现大学信息的智能缓存

### 📁 文件更改
- `routes/admin.py`: 新增管理面板路由
- `routes/index.py`: 支持MongoDB数据源
- `app.py`: 新增PDF服务路由
- `utils/mongo_client.py`: MongoDB连接工具

## 技术债务

### 🔴 高优先级
- 无

### 🟡 中优先级
- 考虑添加PDF文件压缩功能
- 实现GridFS文件的定期清理策略
- 添加文件上传进度监控

### 🟢 低优先级
- 优化GridFS查询性能
- 添加文件访问统计
- 实现文件版本管理

## 已知问题

### 🐛 已修复
- MongoDB文档大小限制问题
- HTTP响应头编码问题
- PDF文件上传失败问题

### ⚠️ 待观察
- GridFS在大文件下的性能表现
- 迁移脚本在大量数据下的稳定性

## 升级指南

### 从文件系统升级到GridFS
1. 备份现有MongoDB数据
2. 运行迁移脚本：`python tools/migrate_to_gridfs.py`
3. 验证迁移结果
4. 清理备份数据（可选）

### 从旧版本升级
1. 更新代码到最新版本
2. 检查MongoDB连接配置
3. 运行必要的迁移脚本
4. 测试所有功能

## 贡献指南

- 所有架构更改必须在`docs/`目录下记录
- 新功能需要更新相应的文档
- 重大更改需要更新此变更日志
- 遵循现有的代码风格和架构模式
