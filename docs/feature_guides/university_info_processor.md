# 招生信息处理器

招生信息处理器是 RunJPLib 的核心功能之一，它允许管理员上传大学的 PDF 招生简章，系统会自动进行一系列处理，最终将结构化的招生信息存入数据库。

## 功能概述

- **自动化处理流程**: 基于工作流引擎，将复杂的处理过程分解为多个独立的、可管理的步骤。
- **异步任务处理**: 所有 PDF 处理都在后台异步执行，管理员可以提交多个任务而无需等待。
- **多种处理模式**: 支持“普通模式”（实时处理）和“批量模式”（成本优化），以适应不同场景的需求。
- **智能名称识别**: 在处理过程中，利用 AI 自动识别并提取大学的简体中文全称。
- **任务管理与监控**: 提供完整的后台界面，用于监控任务进度、查看日志，并支持从任意步骤重启失败的任务。

## 详细实现：Agent 协作工作流

该功能的核心是 `utils/pdf_processor.py` 中的 `PDFProcessor` 类，它基于 `buffalo-workflow` 工作流引擎来编排整个处理流程。任务的每一步都由一个专门的工具或 Agent 来执行。

### 工作流步骤详解

1.  **PDF 转图片 (`01_pdf2img`)**
    - **工具**: `pdf2image` 库
    - **职责**: 接收上传的 PDF 文件路径，将其每一页转换为指定 DPI 的 PNG 图片，为后续的 OCR 处理做准备。

2.  **OCR 识别 (`02_ocr`)**
    - **职责**: 将图片中的文字内容识别出来。
    - **工具 (普通模式)**: `utils/ocr_tool.py` 中的 `OCRTool`。它会遍历所有图片，逐一调用 OpenAI Vision API 进行文字识别。
    - **工具 (批量模式)**: `utils/batch_ocr_tool.py` 中的 `BatchOCRTool`。它会先将所有页面的识别请求打包，通过 OpenAI Batch API 一次性提交，以实现成本优化。

3.  **翻译 Agent (`03_translate`)**
    - **Agent**: `utils/translate_tool.py` 中的 `TranslateTool` 实际上是一个 **翻译 Agent**。
    - **Prompt**: 它接收上一步 OCR 识别出的全部日文文本，并使用一个精心设计的 Prompt 来调用 OpenAI API。该 Prompt 指示 AI：
        - 将所有日文文本翻译成流畅、准确的简体中文。
        - 参考 `TRANSLATE_TERMS_FILE` 中提供的术语表，确保专业词汇（如“出願”、“併願”）翻译的准确性和一致性。
        - 保持原文的格式，如列表、标题等。
    - **输出**: Agent 的输出是完整的简体中文 Markdown 文本。

4.  **分析 Agent (`04_analysis`)**
    - **Agent**: `utils/analysis_tool.py` 中的 `AnalysisTool` 是一个 **分析 Agent**。
    - **Prompt**: 这是提取结构化信息的关键步骤。它向 OpenAI API 提交一个包含多个问题的复杂 Prompt，其核心指令是：
        - “你是一位日本大学招生专家，请根据以下翻译后的招生简章，回答下列问题...”
        - 问题列表从 `ANALYSIS_QUESTIONS_FILE` 文件中加载，涵盖申请条件、学费、日程、所需材料等。
        - **一个至关重要的指令是**：“请在报告的开头，明确标识出这所大学的简体中文全称，格式为：`大学中文名称：[大学的简体中文全名]`”。
    - **输出**: Agent 的输出是一份结构化的分析报告，其中包含了所有问题的答案以及明确标识的大学中文名。

5.  **发布 (`05_output`)**
    - **职责**: 将所有处理完成的数据整理并存入 MongoDB。
    - **流程**:
        1.  **提取中文名**: 从分析 Agent 的报告中，通过正则表达式精确提取 `大学中文名称：` 后的大学名称。
        2.  **存储 PDF**: 将原始 PDF 文件上传到 GridFS。
        3.  **写入数据库**: 创建一个新的 `universities` 文档，将所有处理结果（OCR 文本、翻译文本、分析报告、大学中日文名、GridFS 文件 ID 等）一并存入数据库。

## 任务管理与异步处理

- **任务管理器 (`utils/task_manager.py`)**: 一个单例 `TaskManager` 负责管理所有 PDF 处理任务的生命周期。它维护一个任务队列，并使用后台线程 (`ThreadPoolExecutor`) 来逐一执行任务，实现了任务的异步处理。
- **数据库 (`processing_tasks` 集合)**: 每个任务的状态、日志、当前步骤等信息都会被实时记录到这个集合中，后台管理界面的任务列表和详情页就是通过查询这个集合来展示信息的。