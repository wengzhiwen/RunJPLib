# AI 对话系统

RunJPLib 提供了一个智能 AI 对话系统，允许用户就特定大学的招生信息进行提问和互动。该系统经过精心设计，以确保回答的准确性、用户的隐私和良好的使用体验。

## 核心特性

### 1. 混合搜索 (Hybrid Search)
为了克服传统向量搜索在精确匹配专业术语等方面的不足，对话系统采用了一种先进的混合搜索策略。

- **工作原理**: 当用户提问时，系统会同时执行**向量搜索**（用于理解语义和上下文）和**关键词搜索**（用于精确匹配术语）。
- **智能合并**: 系统会根据预设的权重（关键词匹配优先）和精确匹配的加成分数，智能地合并两种搜索的结果，并重新排序，从而找到最相关的文档片段作为 AI 回答的依据。
- **效果**: 这种策略极大地提高了问答的准确性，特别是对于包含具体课程、要求或费用的问题。

### 2. 隐私保护
用户的隐私是本系统的首要考虑。我们设计了强大的隐私保护机制，以确保对话内容的安全。

- **浏览器会话隔离**: 系统使用基于浏览器 `sessionStorage` 的唯一会话 ID 来隔离每个对话。这意味着：
    - 同一网络下的不同用户不会看到彼此的聊天记录。
    - 浏览器的普通模式和无痕模式完全隔离。
    - 同一用户的不同标签页拥有独立的会话。
- **双重验证**: 在恢复会话时，系统会优先使用浏览器会话 ID 进行验证，仅在旧的、不包含此 ID 的会话中回退使用 IP 地址，确保了向后兼容性。

### 3. 同义词理解
为了更好地理解用户的查询意图，特别是在中日文混合的语境下，系统集成了同义词理解功能。

- **查询扩展**: 系统会加载一个预定义的同义词库（`wasei_kanji.csv`）。当用户提问时，系统会自动检测问题中的关键词，并用其同义词（如“出願”与“报名”）来扩展查询。这使得即使用户使用中文提问，也能准确检索到日文原文中的相关内容。

### 4. 内存与性能优化
- **实时内存监控**: 系统会实时监控内存使用情况。
- **自动清理**: 当内存使用超过阈值（如 80%）时，会自动触发清理机制，释放不再使用的缓存和对象，避免内存泄漏。
- **即时释放**: 每次搜索完成后，会立即释放搜索过程中产生的临时数据，保护用户隐私的同时也保证了系统的性能。

## API 接口

对话系统通过一组 RESTful API (`/api/chat/{university_name}/`) 提供服务。

- `POST /create-session`: 创建或恢复一个安全的聊天会话。
- `POST /send-message`: 发送用户消息，触发混合搜索和 AI 回答的生成。
- `GET /get-history`: 获取当前会话的历史消息。

所有接口都通过 CSRF 令牌和会话 ID 进行保护。

### 发送消息 (`POST /send-message`)

**请求头**:
```
X-Session-ID: <session-id>
X-CSRF-Token: <csrf-token>
```

**请求体**:
```json
{
  "session_id": "uuid-session-id",
  "message": "有计算机系吗？",
  "browser_session_id": "bs_1733123456789_abc123def"
}
```

**成功响应**:
```json
{
  "success": true,
  "response": "是的，东京大学工学部设有情報工学科，属于计算机相关专业...",
  "processing_time": 1.2,
  "search_info": {
    "search_strategy": "hybrid",
    "vector_results": 3,
    "keyword_results": 2,
    "memory_usage": "45.2%",
    "search_time": "0.415s"
  }
}
```

### 错误代码

- `SESSION_NOT_FOUND`: 会话不存在
- `SESSION_EXPIRED`: 会话已过期
- `SESSION_ACCESS_DENIED`: 会话访问被拒绝
- `BROWSER_SESSION_MISMATCH`: 浏览器会话ID不匹配
- `SEARCH_TIMEOUT`: 搜索超时
- `MEMORY_LIMIT_EXCEEDED`: 内存使用超限
- `INTERNAL_SERVER_ERROR`: 内部服务器错误