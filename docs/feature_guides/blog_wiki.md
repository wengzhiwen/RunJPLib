# 博客自动 Wiki 功能

为了增强站内内容的关联性和用户导航体验，RunJPLib 的博客系统集成了一套自动化的 Wiki 功能。该功能会在博客文章保存或更新时，自动为文中出现的大学名称添加指向其在本站招生信息页面的链接。

## 功能目标

- **自动化**: 对管理员完全透明，无需任何手动操作。
- **提升 SEO**: 增加内部链接，优化网站结构。
- **改善用户体验**: 用户可以方便地从博客文章跳转到相关的大学详细信息页面。

## 实现机制

该功能的核心逻辑位于 `utils/blog_wiki_processor.py` 中，并在 `routes/admin.py` 的博客保存和更新路由中被调用。

### 触发时机

- 在管理员点击“新建博客”或“编辑博客”页面的“保存”按钮时，在将博客内容写入数据库**之前**触发。

### 工作流程

1.  **获取大学名录**: 
    - 系统会从 `universities` 集合中获取所有大学的日文名 (`university_name`) 和中文名 (`university_name_zh`)。
    - **缓存**: 这个大学名录（约几百个名称）会被缓存在内存中，以避免每次都查询数据库，提升性能。

2.  **文本节点遍历**: 
    - 系统会解析博客的 Markdown 内容，但并不会粗暴地进行全局文本替换。相反，它会遍历文本节点，**忽略**已经存在于超链接 (`<a>` 标签) 或代码块 (`<pre>`, `<code>`) 内的文本，防止破坏已有的链接和代码格式。

3.  **智能匹配**: 
    - 使用获取到的大学名录，在纯文本节点中进行反向匹配。
    - **最长匹配原则**: 如果一段文本同时匹配到多个大学名称（例如，同时匹配“东京大学”和“东京大学大学院”），系统会优先选择**最长**的那一个（“东京大学大学院”）进行链接。这确保了链接的精确性，避免了将“东京大学大学院”错误地链接到“东京大学”页面。

4.  **链接生成与替换**: 
    - 对匹配到的大学名称，系统会生成一个标准的 Markdown 链接，格式为 `[大学名称](<URL>)`。
    - URL 会被正确地进行编码，以处理日文和中文字符。
    - 完成替换后，返回处理过的 Markdown 全文。

### 示例

**处理前**: 
```markdown
今天我们来介绍一下东京大学和京都艺术大学的申请要求。
```

**处理后**: 
```markdown
今天我们来介绍一下[东京大学](/university/东京大学)和[京都艺术大学](/university/京都艺术大学)的申请要求。
```

## 关键技术点

- **性能**: 通过缓存大学名录，避免了高频的数据库查询。
- **准确性**: 采用最长匹配原则，保证了链接的精确度。
- **健壮性**: 通过忽略已有链接和代码块中的内容，避免了对文章结构的破坏。
