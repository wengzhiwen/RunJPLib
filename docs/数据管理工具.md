# 数据管理工具

本文档描述了RunJPLib项目用于管理MongoDB数据库内容的后台工具。

## 概述

随着项目数据源完全迁移至MongoDB，我们建立了一个基于Web的内部管理后台，以取代旧的、基于本地文件的管理方式。该后台是所有大学信息和博客文章的统一管理入口。

## 技术架构

- **后端**: 基于Flask框架，使用`Blueprint`构建，路由位于`/admin`。
- **认证**: 通过JWT (JSON Web Tokens) 实现。
    - 认证凭证以`HttpOnly` Cookie的形式存储，增强了安全性。
    - 所有后台页面和API均受到保护，未认证的页面访问会被重定向至登录页。
- **前端**: 使用基础的HTML、CSS和JavaScript，通过API与后端进行异步数据交互。

## 主要功能

### 1. 登录 (`/admin/login`)
管理员通过输入在环境变量中配置的`ACCESS_CODE`进行登录，成功后服务器会下发认证Cookie。

### 2. 仪表盘 (`/admin`)
后台首页，是各个管理模块的入口。

### 3. 大学信息管理 (`/admin/manage/universities`)
- **数据展示**: 以表格形式展示当前`universities`集合中的所有文档。
- **核心操作**:
    - **查看**: 提供跳转链接，可在用户前端视角查看该大学的详情页面。
    - **删除**: 支持删除单条大学信息。
    - **清空**: 支持一键清空整个`universities`集合（危险操作，需要确认）。

### 4. 博客文章管理 (`/admin/manage/blogs`)
- **数据展示**: 以表格形式展示`blogs`集合中的所有文章，并包含以下关键信息：
    - **Markdown更新时间**: `md_last_updated`字段，在上传时自动更新。
    - **HTML更新时间**: `html_last_updated`字段，在“延迟渲染”机制触发时更新。
    - **HTML状态**: 根据上述两个时间戳动态计算，直观展示HTML内容是否为最新。
- **核心操作**:
    - **核心操作**:
    - **查看**: 提供跳转链接，可在用户前端视角查看该博客文章。
    - **编辑**: 跳转至 `/admin/blog/edit/<blog_id>` 页面，允许管理员直接修改标题和Markdown原文。提交后，后端会更新数据库中的相应文档。
    - **删除**: 支持删除单篇博客。
    - **清空**: 支持一键清空整个`blogs`集合。

## 数据源
本项目已**完全移除**对本地文件系统的依赖（`pdf_with_md*`文件夹和旧的`blogs`文件夹）。所有大学和博客数据均以MongoDB为唯一数据源。
- **大学PDF文件**: 通过GridFS进行存储和提供服务，解决了MongoDB的16MB文档大小限制。
- **数据缓存**: 对频繁访问的数据（如首页大学列表、博客列表、分类信息）在应用层进行了基于时间的内存缓存，以提升性能并降低数据库负载。

## AI内容生成工具

除了数据的手动管理，后台还集成了一套强大的AI内容生成工具，入口位于 **“新建博客”**。

### 1. 核心功能
该工具旨在将 `ref` 文件夹中的旧版、离线的 `blog_writer.py` 脚本功能，完全在线化、产品化。它允许管理员直接在后台调用AI，高效地生成高质量的博客文章。

### 2. 技术实现
- **核心模块**: `utils/blog_generator.py` 封装了所有与AI交互的逻辑。
- **AI服务**: 通过 `buffalo-workflow` 库与大语言模型（如GPT-4o）进行交互。
- **异步处理**: 使用 `nest_asyncio` 解决了在Flask同步工作线程中调用异步AI库的事件循环问题。
- **多模式生成**:
    - **材料扩展**: 基于大学原文进行内容扩展。
    - **对比分析**: 实现了`ref`脚本中的两阶段生成逻辑，即先调用“缩减Agent”对原文进行摘要，再调用“对比Agent”生成综合性文章。
    - **用户提示词**: 仅基于用户输入进行创作。
- **内容格式化**: 所有AI生成的内容都会经过一个专门的“格式化Agent”进行处理，确保输出的是格式规范、可以直接发布的Markdown文本。

### 3. 相关API
- `POST /admin/api/blog/generate`: 接收前端指定的模式和数据，调用`BlogGenerator`执行生成任务，并将结果返回。
- `GET /admin/api/universities/search`: 为前端提供大学名称的实时搜索功能。
