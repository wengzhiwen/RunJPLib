# 首页 (Homepage) 功能说明

本文档详细介绍了 RunJPLib 项目首页的结构、功能模块、数据流和技术实现。

## 1. 概述

首页是整个应用的核心入口，旨在为用户提供一个清晰、高效的导航界面，以便快速访问最新的大学招生信息、推荐的博客文章以及完整的大学分类索引。页面采用响应式设计，适配桌面和移动设备。

## 2. 页面结构

首页主要由以下几个部分组成：

- **顶部导航栏 (Top Navigation Bar)**:
  - **Logo与标题**: 网站的品牌标识。
  - **模式切换**: “信息库”和“博客”两个主要板块的切换按钮。
  - **移动端菜单**: 在移动设备上，提供一个可折叠的菜单，包含完整的大学列表或博客列表。

- **侧边栏 (Sidebar)** (仅桌面端):
  - **大学列表**: 展示所有已收录的大学，并按 Premium 状态和截止日期排序。用户可以通过浏览器的搜索功能 (Ctrl/Cmd + F) 快速查找。

- **主内容区 (Main Content)**:
  - **网站标题与搜索框**: 页面核心标题和客户端搜索功能。
  - **最新更新 (Latest Updates)**: 动态展示最近更新的大学信息。
  - **推荐阅读 (Recommended Reading)**: 随机展示精选的博客文章。
  - **快速索引 (Quick Index)**: 按预设分类展示所有大学的入口。
  - **页脚信息**: 包括功能说明、问题报告链接 (GitHub Issues) 和许可证信息。

## 3. 功能模块详解

### 3.1. 大学列表与搜索

- **功能描述**:
  - 侧边栏和移动端菜单会展示一个完整的大学列表，点击链接可直接跳转到对应的大学详情页。
  - 搜索框提供客户端实时搜索功能，用户输入大学日文名后，侧边栏的列表会高亮并过滤匹配项。
- **数据来源**: MongoDB `universities` 集合。
- **后端逻辑**:
  - `routes/index.py` 中的 `get_sorted_universities_for_index()` 函数负责从数据库获取数据。
  - **去重与排序**: 使用 MongoDB 聚合管道 (`aggregate`)，确保每个大学只返回其最新的一条记录（优先考虑 `is_premium` 和 `deadline`），避免了前端出现重复链接。
  - **缓存**: 查询结果被 `TTLCache` 缓存600秒，以降低数据库负载。
- **前端渲染**:
  - `templates/index.html` 中，通过 `{% for uni in universities %}` 循环渲染列表。
  - 搜索功能由原生的 JavaScript 实现，通过监听 `input` 事件来过滤和高亮列表项。

### 3.2. 最新更新

- **功能描述**: 以紧凑的卡片形式展示最近更新的15条大学信息，Premium 大学有特殊的视觉高亮。
- **数据来源**: MongoDB `universities` 集合。
- **后端逻辑**:
  - `routes/index.py` 中的 `get_latest_updates()` 函数负责查询。
  - 查询逻辑按文档创建时间 (`_id`) 降序排序，并限制返回15条记录。
  - **缓存**: 结果同样被 `TTLCache` 缓存600秒。
- **前端渲染**:
  - `templates/index.html` 中，通过 `{% for update in latest_updates %}` 循环渲染卡片。
  - 使用 Bootstrap 的响应式网格系统 (`row-cols-*`) 来实现多列布局。
  - 通过 `{% if update.is_premium %}` 判断来添加高亮样式。

### 3.3. 推荐阅读

- **功能描述**: 使用优化的时间权重算法展示3篇博客文章的标题和摘要，让最新的博客有更高的展示权重，引导用户发现优质内容。
- **数据来源**: MongoDB `blogs` 集合。
- **后端逻辑**:
  - `routes/blog.py` 中的 `get_weighted_recommended_blogs_with_summary(count)` 函数负责实现。
  - **优化后的时间权重算法**:
    1. **Step 1**: 从最近3天的blog中选2条（提升最新内容权重）
    2. **Step 2**: 从最近7天的blog中选不重复的补足3条（智能补足机制）
    3. **Step 3**: 从剩下的blog中选不重复的补足3条（兜底选择）
  - **智能补足机制**: Step 2会计算还需要多少篇才能达到目标数量，确保优先选择最近7天的内容。
  - **容错机制**: 如果某个时间段没有足够的blog，会从其他时间段补充，确保总能推荐到指定数量的文章。
  - **避免重复**: 确保同一页面不会推荐重复的博客文章。
  - **摘要生成**: 使用markdown库将markdown内容转换为HTML，然后去除HTML标签生成纯文本摘要，确保摘要中不包含任何markdown语法标记。
- **前端渲染**:
  - `templates/index.html` 中，通过 `{% for blog in recommended_blogs %}` 循环渲染推荐文章卡片。

### 3.4. 快速索引

- **功能描述**:
  - 这是首页的核心导航功能，将所有大学按照预定义的类别进行分组展示。
  - 对于“主要国公立”和“主要私立”这两个大学数量较多的分类，会进一步按地理区域（关东、关西、中部、东北、其他）进行二级分组，以方便用户查找。
- **数据来源**: `data/university_categories.csv` 文件。
- **后端逻辑**:
  - `routes/index.py` 中的 `load_categories()` 函数负责加载和处理。
  - **数据加载**: 函数启动时会读取 CSV 文件，并将内容解析为一个以 `category` 为键的字典。
  - **分组与排序**:
    - 如果分类是“主要国公立”或“主要私立”，则会根据 `area` 字段进行二次分组。
    - 地区的显示顺序是按照 `['関東', '関西', '中部', '東北', 'その他']` 这个预设列表进行自定义排序的，确保了展示的逻辑性。
  - **缓存**: `load_categories()` 的结果会被 `TTLCache` 缓存1小时（3600秒），因为这个文件不经常变动。
- **前端渲染**:
  - `templates/index.html` 中，外层循环遍历 `categories.items()`。
  - **动态结构处理**: 使用 `{% if unis is mapping %}` 这个 Jinja2 的内置测试来判断当前分类的值是一个字典（已按地区分组）还是一个列表。
    - 如果是字典，则会渲染带有地区标题 (`<h4>`) 的二级分组结构。
    - 如果是列表，则直接渲染大学列表。
  - 这种处理方式使得模板能够优雅地兼容两种不同的数据结构。

## 4. 配置文件

- **`data/university_categories.csv`**:
  - 这是“快速索引”模块的唯一数据源。
  - 文件包含 `category`, `name`, `ja_name`, `short_name`, `area` 等列。
  - 若要调整分类、增删大学或修改地区，只需直接编辑此文件即可，后端逻辑会自动适应。

## 5. 未来可优化方向

- **服务端搜索**: 当前的搜索功能是客户端实现的，当大学数量极大时，可能会有性能瓶颈。未来可以考虑将其改为服务端搜索，通过API返回结果。
- **个性化推荐**: "推荐阅读"模块已实现优化的时间权重算法，未来可以基于用户行为或内容标签实现更智能的个性化推荐。
